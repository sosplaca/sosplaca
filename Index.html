<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SOS Placa</title>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css">
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            background: linear-gradient(to right, #0077ff, #00c3ff);
            color: #fff;
            text-align: center;
            margin: 0;
            padding: 0;
        }
        .container {
            max-width: 500px;
            margin: auto;
            background-color: rgba(0, 0, 50, 0.8);
            padding: 20px;
            border-radius: 15px;
            margin-top: 40px;
            box-shadow: 0 0 15px rgba(0,0,0,0.6);
        }
        h1 {
            margin-bottom: 20px;
        }
        button {
            background-color: #00c3ff;
            color: #fff;
            border: none;
            padding: 12px 20px;
            margin: 5px;
            border-radius: 10px;
            cursor: pointer;
            transition: 0.3s;
        }
        button:hover {
            background-color: #0077ff;
        }
        input, select {
            padding: 10px;
            border-radius: 8px;
            border: none;
            width: 90%;
            margin: 5px 0;
        }
        .hidden {
            display: none;
        }
        .placa-item {
            background: #fff;
            color: #000;
            border-radius: 8px;
            padding: 8px;
            margin: 5px 0;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>SOS PLACA</h1>
    <div id="menu">
        <button onclick="mostrar('perdi')">Perdi</button>
        <button onclick="mostrar('achei')">Achei</button>
        <button onclick="mostrar('admin')">Administrador</button>
    </div>

    <!-- Achei -->
    <div id="achei" class="hidden">
        <h2>Cadastre uma Placa Encontrada</h2>
        <select id="tipoAchei">
            <option value="comum">Comum (XXX-1234)</option>
            <option value="mercosul">Mercosul (XXX1X23)</option>
        </select><br>
        <input type="text" id="placaAchei" placeholder="Digite a placa"><br>
        <input type="text" id="nomeAchei" placeholder="Seu nome"><br>
        <input type="text" id="telefoneAchei" placeholder="Seu telefone"><br>
        <button onclick="cadastrarPlaca()">Salvar</button>
        <button onclick="voltar()">Voltar</button>
    </div>

    <!-- Perdi -->
    <div id="perdi" class="hidden">
        <h2>Busque sua Placa</h2>
        <select id="tipoPerdi">
            <option value="comum">Comum (XXX-1234)</option>
            <option value="mercosul">Mercosul (XXX1X23)</option>
        </select><br>
        <input type="text" id="placaPerdi" placeholder="Digite a placa"><br>
        <button onclick="buscarPlaca()">Buscar</button>
        <button onclick="voltar()">Voltar</button>
        <div id="resultadoBusca"></div>
    </div>

    <!-- Admin -->
    <div id="adminLogin" class="hidden">
        <h2>Login Administrador</h2>
        <input type="text" id="login" placeholder="Login"><br>
        <input type="password" id="senha" placeholder="Senha"><br>
        <button onclick="loginAdmin()">Entrar</button>
        <button onclick="voltar()">Voltar</button>
    </div>

    <div id="adminArea" class="hidden">
        <h2>Área do Administrador</h2>
        <div id="listaPlacas"></div>
        <button onclick="sairAdmin()">Sair</button>
    </div>
</div>

<script>
    // Configuração Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyClzqFmEL9y_ugHnC7V4DnFiANX6RLDYzc",
        authDomain: "teste-c702e.firebaseapp.com",
        databaseURL: "https://teste-c702e-default-rtdb.firebaseio.com",
        projectId: "teste-c702e",
        storageBucket: "teste-c702e.appspot.com",
        messagingSenderId: "478905955045",
        appId: "1:478905955045:web:bb9d0623db8a9166e85a0c"
    };
    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Funções de navegação
    function mostrar(tela) {
        document.getElementById('menu').classList.add('hidden');
        document.getElementById(tela).classList.remove('hidden');
    }
    function voltar() {
        document.querySelectorAll('.container > div').forEach(e => e.classList.add('hidden'));
        document.getElementById('menu').classList.remove('hidden');
        document.getElementById('resultadoBusca').innerHTML = '';
    }

    // Validação de placas
    function validarPlaca(placa, tipo) {
        const comum = /^[A-Z]{3}-\d{4}$/;
        const mercosul = /^[A-Z]{3}[0-9][A-Z][0-9]{2}$/;
        return tipo === "comum" ? comum.test(placa) : mercosul.test(placa);
    }

    // Cadastro
    async function cadastrarPlaca() {
        const tipo = document.getElementById('tipoAchei').value;
        const placa = document.getElementById('placaAchei').value.toUpperCase();
        const nome = document.getElementById('nomeAchei').value;
        const telefone = document.getElementById('telefoneAchei').value;

        if (!validarPlaca(placa, tipo)) {
            alert('Placa inválida.');
            return;
        }
        if (nome === "" || telefone === "") {
            alert('Preencha todos os campos.');
            return;
        }

        const snapshot = await db.ref('placas/' + placa).get();
        const count = snapshot.exists() && snapshot.val().cadastros ? snapshot.val().cadastros.length : 0;

        if (count >= 2) {
            alert('Essa placa já possui 2 cadastros.');
            return;
        }

        const novoCadastro = {
            nome,
            telefone,
            data: new Date().toLocaleString(),
            tipo
        };

        const atual = snapshot.exists() && snapshot.val().cadastros ? snapshot.val().cadastros : [];
        atual.push(novoCadastro);

        await db.ref('placas/' + placa).set({
            tipo,
            cadastros: atual
        });

        alert('Cadastro realizado com sucesso! Você está ajudando a sociedade.');
        voltar();
    }

    // Busca
    async function buscarPlaca() {
        const tipo = document.getElementById('tipoPerdi').value;
        const placa = document.getElementById('placaPerdi').value.toUpperCase();
        const resultadoDiv = document.getElementById('resultadoBusca');
        resultadoDiv.innerHTML = '';

        if (!validarPlaca(placa, tipo)) {
            alert('Placa inválida.');
            return;
        }

        const snapshot = await db.ref('placas/' + placa).get();

        if (!snapshot.exists()) {
            resultadoDiv.innerHTML = "<p>Placa não encontrada. Tente novamente mais tarde.</p>";
            return;
        }

        const dados = snapshot.val();
        resultadoDiv.innerHTML = `<h3>Placa Encontrada!</h3>`;
        dados.cadastros.forEach(c => {
            resultadoDiv.innerHTML += `
                <div class="placa-item">
                    <b>Nome:</b> ${c.nome}<br>
                    <b>Telefone:</b> ${c.telefone}<br>
                    <b>Data:</b> ${c.data}<br>
                    <button onclick="removerPlaca('${placa}', '${c.nome}')">Remover</button>
                </div>
            `;
        });
    }

    // Remoção de cadastro
    async function removerPlaca(placa, nome) {
        const snapshot = await db.ref('placas/' + placa).get();
        if (!snapshot.exists()) return;

        let cadastros = snapshot.val().cadastros.filter(c => c.nome !== nome);

        if (cadastros.length === 0) {
            await db.ref('placas/' + placa).remove();
        } else {
            await db.ref('placas/' + placa).update({ cadastros });
        }

        alert('Cadastro removido com sucesso.');
        buscarPlaca();
    }

    // Login Admin
    function loginAdmin() {
        const user = document.getElementById('login').value;
        const pass = document.getElementById('senha').value;

        if (user === 'fabricioubatuba2025' && pass === 'fabricioubatuba2025') {
            document.getElementById('adminLogin').classList.add('hidden');
            document.getElementById('adminArea').classList.remove('hidden');
            listarPlacas();
        } else {
            alert('Login ou senha incorretos.');
        }
    }

    function sairAdmin() {
        document.getElementById('adminArea').classList.add('hidden');
        voltar();
    }

    async function listarPlacas() {
        const lista = document.getElementById('listaPlacas');
        lista.innerHTML = '';
        const snapshot = await db.ref('placas').get();

        if (!snapshot.exists()) {
            lista.innerHTML = "<p>Não há placas cadastradas.</p>";
            return;
        }

        snapshot.forEach(child => {
            const p = child.key;
            const dados = child.val();

            let item = `<div class="placa-item"><b>Placa:</b> ${p}<br><b>Tipo:</b> ${dados.tipo}<br>`;

            dados.cadastros.forEach(c => {
                item += `- ${c.nome} (${c.telefone}) em ${c.data}<br>`;
            });

            item += `</div>`;
            lista.innerHTML += item;
        });
    }
</script>
</body>
</html>
