<!-- Tela Perdi uma Placa -->
<div id="perdi-screen" class="screen">
  <h2>Verificar placa perdida</h2>
  <div class="form-group">
    <label>Tipo de placa:</label>
    <div style="display: flex; gap: 0.625rem;">
      <button id="btn-perdi-comum" class="btn ativo">Comum</button>
      <button id="btn-perdi-mercosul" class="btn">Mercosul</button>
    </div>
  </div>
  <div class="form-group">
    <label for="perdi-placa">N√∫mero da placa:</label>
    <input type="text" id="perdi-placa" placeholder="AAA-0000 ou AAA0A00" required>
  </div>
  <div class="form-group" id="perdi-localizacao">
    <label for="perdi-uf">UF:</label>
    <select id="perdi-uf">
      <option value="" disabled selected>Selecione o estado</option>
      <option value="AC">AC</option>
      <option value="AL">AL</option>
      <!-- Todos os outros estados aqui -->
    </select>
    <label for="perdi-municipio">Munic√≠pio:</label>
    <select id="perdi-municipio">
      <option value="" disabled selected>Selecione o munic√≠pio</option>
    </select>
  </div>

  <div class="alert-box">
    <strong>‚ö†Ô∏è Aten√ß√£o:</strong><br>
    N√£o cobramos e nem intermediamos qualquer valor pela devolu√ß√£o de placas.<br>
    Oferecer uma gratifica√ß√£o √© algo opcional, decidido entre quem perdeu e quem encontrou.<br>
    Se achar necess√°rio, entre em contato com as autoridades.
  </div>

  <div>
    <button id="perdi-verificar" class="btn btn-success">Verificar Placa</button>
    <button class="btn btn-secondary" onclick="voltarMenu()">Voltar</button>
  </div>
  <div id="perdi-result" class="result"></div>
</div>

<!-- Tela Achei uma Placa -->
<div id="achei-screen" class="screen">
  <h2>Cadastrar placa encontrada</h2>
  <div class="form-group">
    <label>Tipo de placa:</label>
    <div style="display: flex; gap: 0.625rem;">
      <button id="btn-achei-comum" class="btn ativo">Comum</button>
      <button id="btn-achei-mercosul" class="btn">Mercosul</button>
    </div>
  </div>
  <div class="form-group">
    <label for="achei-placa">N√∫mero da placa:</label>
    <input type="text" id="achei-placa" placeholder="AAA-0000 ou AAA0A00" required>
  </div>

  <div class="form-group" id="achei-localizacao">
    <label for="achei-uf">UF:</label>
    <select id="achei-uf">
      <option value="" disabled selected>Selecione o estado</option>
      <option value="AC">AC</option>
      <option value="AL">AL</option>
      <!-- Todos os outros estados aqui -->
    </select>
    <label for="achei-municipio">Munic√≠pio:</label>
    <select id="achei-municipio">
      <option value="" disabled selected>Selecione o munic√≠pio</option>
    </select>
  </div>
  <div class="form-group">
    <label for="achei-nome">Seu nome:</label>
    <input type="text" id="achei-nome" placeholder="Digite seu nome completo" required>
  </div>
  <div class="form-group">
    <label for="achei-telefone">Seu telefone:</label>
    <input type="tel" id="achei-telefone" placeholder="(00) 00000-0000" required>
  </div>
  <div>
    <button id="achei-salvar" class="btn btn-success">Salvar Placa</button>
    <button class="btn btn-secondary" onclick="voltarMenu()">Voltar</button>
  </div>
  <div id="achei-result" class="result"></div>
</div>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
  import { 
    getAuth, 
    createUserWithEmailAndPassword, 
    signInWithEmailAndPassword, 
    signOut,
    onAuthStateChanged
  } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
  import { 
    getFirestore, 
    collection, 
    addDoc, 
    serverTimestamp, 
    getDocs, 
    query, 
    where 
  } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";
  import { 
    getDatabase, 
    ref, 
    set, 
    get, 
    child 
  } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBjetihGmlo_z01jx-GW9Ith0oDCS0jwYc",
    authDomain: "sosplaca-73cf7.firebaseapp.com",
    databaseURL: "https://sosplaca-73cf7-default-rtdb.firebaseio.com",
    projectId: "sosplaca-73cf7",
    storageBucket: "sosplaca-73cf7.appspot.com",
    messagingSenderId: "658059385722",
    appId: "1:658059385722:web:5ed0e8fd7f7a2931d894c3"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const firestore = getFirestore(app);
  const realtimeDb = getDatabase(app);

  // Fun√ß√µes de navega√ß√£o e inicializa√ß√£o
  function mostrarTela(id) {
    document.querySelectorAll('.screen').forEach(screen => screen.classList.remove('active'));
    document.getElementById(id).classList.add('active');
  }

  function voltarMenu() {
    mostrarTela('menu-screen');
  }
  window.voltarMenu = voltarMenu;

  // Carregar Minhas Placas corrigido
  async function carregarMinhasPlacas(userId) {
    const content = document.getElementById('minhas-placas-content');
    content.innerHTML = '<p>Carregando suas placas...</p>';
    
    try {
      const q = query(collection(firestore, 'foundPlates'), where('userId', '==', userId));
      const querySnapshot = await getDocs(q);
      
      if (querySnapshot.empty) {
        content.innerHTML = '<p>Voc√™ ainda n√£o cadastrou nenhuma placa perdida.</p>';
        return;
      }
      
      let html = '<div class="user-plates">';
      querySnapshot.forEach(doc => {
        const data = doc.data();
        const date = data.foundDate?.toDate ? data.foundDate.toDate() : new Date();
        
        html += `
          <div class="plate-card">
            <p><strong>Placa:</strong> ${data.plate}</p>
            <p><strong>Data:</strong> ${date.toLocaleDateString()}</p>
            <p><strong>Local:</strong> ${data.location.city || 'N√£o especificado'}/${data.location.uf || 'N√£o especificado'}</p>
          </div>
        `;
      });
      html += '</div>';
      content.innerHTML = html;
    } catch (error) {
      console.error('Erro ao carregar placas:', error);
      content.innerHTML = '<p class="error">Erro ao carregar suas placas. Tente novamente.</p>';
    }
  }

  // Carregar Perfil corrigido
  async function carregarPerfil(userId) {
    const content = document.getElementById('perfil-content');
    content.innerHTML = '<p>Carregando seu perfil...</p>';
    
    try {
      // Primeiro verifica no Firestore
      const q = query(collection(firestore, 'users'), where('userId', '==', userId));
      const querySnapshot = await getDocs(q);
      
      if (!querySnapshot.empty) {
        const userData = querySnapshot.docs[0].data();
        const html = `
          <div class="profile-info">
            <p><strong>Nome:</strong> ${userData.name}</p>
            <p><strong>E-mail:</strong> ${userData.email}</p>
            <p><strong>Telefone:</strong> ${userData.phone || 'N√£o cadastrado'}</p>
            <button id="btn-logout" class="btn btn-danger" style="margin-top: 20px;">Sair</button>
          </div>
        `;
        content.innerHTML = html;
      } else {
        // Se n√£o encontrou no Firestore, pega apenas do Auth
        const user = auth.currentUser;
        const html = `
          <div class="profile-info">
            <p><strong>E-mail:</strong> ${user.email}</p>
            <p>Seus dados completos n√£o foram encontrados.</p>
            <button id="btn-logout" class="btn btn-danger" style="margin-top: 20px;">Sair</button>
          </div>
        `;
        content.innerHTML = html;
      }
      
      document.getElementById('btn-logout').addEventListener('click', fazerLogout);
    } catch (error) {
      console.error('Erro ao carregar perfil:', error);
      content.innerHTML = '<p class="error">Erro ao carregar seu perfil. Tente novamente.</p>';
    }
  }

  // Login corrigido para usu√°rios do App
  document.getElementById('btn-login').addEventListener('click', async () => {
    const email = document.getElementById('login-email').value.trim();
    const senha = document.getElementById('login-senha').value.trim();
    const result = document.getElementById('login-result');
    
    if (!email || !senha) {
      result.textContent = 'Preencha todos os campos.';
      result.style.display = 'block';
      return;
    }
    
    try {
      await signInWithEmailAndPassword(auth, email, senha);
      result.textContent = 'Login realizado com sucesso!';
      result.style.display = 'block';
      
      // Redirecionar para o menu ap√≥s login
      setTimeout(() => {
        mostrarTela('menu-screen');
      }, 1000);
    } catch (error) {
      console.error('Erro no login:', error);
      let errorMessage = 'Erro ao fazer login.';
      
      if (error.code === 'auth/wrong-password') {
        errorMessage = 'Senha incorreta.';
      } else if (error.code === 'auth/user-not-found') {
        errorMessage = 'Usu√°rio n√£o encontrado.';
      } else if (error.code === 'auth/invalid-email') {
        errorMessage = 'E-mail inv√°lido.';
      }
      
      result.textContent = errorMessage;
      result.style.display = 'block';
    }
  });

  // Cadastro corrigido para compatibilidade com o App
  document.getElementById('btn-cadastrar').addEventListener('click', async () => {
    const nome = document.getElementById('cadastro-nome').value.trim();
    const email = document.getElementById('cadastro-email').value.trim();
    const telefone = document.getElementById('cadastro-telefone').value.trim();
    const senha = document.getElementById('cadastro-senha').value.trim();
    const confirmarSenha = document.getElementById('cadastro-confirmar-senha').value.trim();
    const result = document.getElementById('cadastro-result');
    
    // Valida√ß√µes
    if (!nome || !email || !telefone || !senha || !confirmarSenha) {
      result.textContent = 'Preencha todos os campos.';
      result.style.display = 'block';
      return;
    }
    
    if (senha !== confirmarSenha) {
      result.textContent = 'As senhas n√£o coincidem.';
      result.style.display = 'block';
      return;
    }
    
    if (senha.length < 6) {
      result.textContent = 'A senha deve ter pelo menos 6 caracteres.';
      result.style.display = 'block';
      return;
    }
    
    try {
      // Criar usu√°rio no Authentication
      const userCredential = await createUserWithEmailAndPassword(auth, email, senha);
      const userId = userCredential.user.uid;
      
      // Salvar dados adicionais no Firestore (compat√≠vel com o App)
      await addDoc(collection(firestore, 'users'), {
        userId: userId,
        name: nome,
        email: email,
        phone: telefone,
        createdAt: serverTimestamp()
      });
      
      result.textContent = 'Cadastro realizado com sucesso! Fa√ßa login para continuar.';
      result.style.display = 'block';
      
      // Limpar campos ap√≥s cadastro
      document.getElementById('cadastro-nome').value = '';
      document.getElementById('cadastro-email').value = '';
      document.getElementById('cadastro-telefone').value = '';
      document.getElementById('cadastro-senha').value = '';
      document.getElementById('cadastro-confirmar-senha').value = '';
      
      // Redirecionar para login ap√≥s 2 segundos
      setTimeout(() => {
        mostrarTela('login-screen');
      }, 2000);
    } catch (error) {
      console.error('Erro no cadastro:', error);
      let errorMessage = 'Erro ao cadastrar. Tente novamente.';
      
      if (error.code === 'auth/email-already-in-use') {
        errorMessage = 'Este e-mail j√° est√° cadastrado.';
      } else if (error.code === 'auth/invalid-email') {
        errorMessage = 'E-mail inv√°lido.';
      } else if (error.code === 'auth/weak-password') {
        errorMessage = 'A senha √© muito fraca.';
      }
      
      result.textContent = errorMessage;
      result.style.display = 'block';
    }
  });

  // Observar estado de autentica√ß√£o
  onAuthStateChanged(auth, (user) => {
    if (user) {
      console.log('Usu√°rio logado:', user.email);
      // Atualizar UI para usu√°rio logado se necess√°rio
    } else {
      console.log('Usu√°rio n√£o logado');
    }
  });

  // Inicializa√ß√£o
  document.addEventListener('DOMContentLoaded', () => {
    // Configura√ß√µes iniciais
    document.getElementById('btn-achei-comum').click();
    document.getElementById('btn-perdi-comum').click();
    
    // Verifica se j√° est√° logado
    const user = auth.currentUser;
    if (user) {
      console.log('Usu√°rio j√° logado:', user.email);
    }
  });
</script>
<script>
  // üîó Lista de estados e munic√≠pios (mantida igual)
  const cidadesPorEstado = {
    // ... (seu objeto completo de cidades por estado)
  };

  // üß† Atualizar munic√≠pios
  function atualizarMunicipios(ufId, municipioId) {
    const uf = document.getElementById(ufId).value;
    const municipioSelect = document.getElementById(municipioId);
    municipioSelect.innerHTML = '<option value="" disabled selected>Selecione o munic√≠pio</option>';

    if (cidadesPorEstado[uf]) {
      cidadesPorEstado[uf].forEach(cidade => {
        const option = document.createElement('option');
        option.value = cidade;
        option.textContent = cidade;
        municipioSelect.appendChild(option);
      });
    }
  }

  // üéØ Eventos para UF ‚Üí Munic√≠pio
  document.getElementById('achei-uf').addEventListener('change', () => {
    atualizarMunicipios('achei-uf', 'achei-municipio');
  });
  document.getElementById('perdi-uf').addEventListener('change', () => {
    atualizarMunicipios('perdi-uf', 'perdi-municipio');
  });

  // üõ†Ô∏è Controle tipo de placa ‚Äî Achei
  document.querySelectorAll('#btn-achei-comum, #btn-achei-mercosul').forEach(btn => {
    btn.addEventListener('click', function() {
      document.querySelectorAll('#achei-screen .btn').forEach(b => b.classList.remove('ativo'));
      this.classList.add('ativo');

      const isComum = this.id === 'btn-achei-comum';
      document.getElementById('achei-placa').placeholder = isComum ? 'AAA-0000' : 'AAA0A00';
      document.getElementById('achei-localizacao').style.display = isComum ? 'block' : 'none';
    });
  });

  // üõ†Ô∏è Controle tipo de placa ‚Äî Perdi
  document.querySelectorAll('#btn-perdi-comum, #btn-perdi-mercosul').forEach(btn => {
    btn.addEventListener('click', function() {
      document.querySelectorAll('#perdi-screen .btn').forEach(b => b.classList.remove('ativo'));
      this.classList.add('ativo');

      const isComum = this.id === 'btn-perdi-comum';
      document.getElementById('perdi-placa').placeholder = isComum ? 'AAA-0000' : 'AAA0A00';
      document.getElementById('perdi-localizacao').style.display = isComum ? 'block' : 'none';
    });
  });

  // üì≤ M√°scara telefone
  document.getElementById('achei-telefone').addEventListener('input', function() {
    let value = this.value.replace(/\D/g, '').slice(0, 11);
    if (value.length > 2) value = `(${value.substring(0, 2)}) ${value.substring(2)}`;
    if (value.length > 10) value = `${value.substring(0, 10)}-${value.substring(10)}`;
    this.value = value;
  });

  // üìÑ M√°scara placas
  function aplicarMascaraPlaca(inputId, isComum) {
    const input = document.getElementById(inputId);
    let value = input.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
    if (isComum) {
      value = value.slice(0, 7);
      if (value.length > 3) value = `${value.slice(0, 3)}-${value.slice(3)}`;
    } else {
      value = value.slice(0, 7);
    }
    input.value = value;
  }

  document.getElementById('achei-placa').addEventListener('input', function() {
    const isComum = document.getElementById('btn-achei-comum').classList.contains('ativo');
    aplicarMascaraPlaca('achei-placa', isComum);
  });

  document.getElementById('perdi-placa').addEventListener('input', function() {
    const isComum = document.getElementById('btn-perdi-comum').classList.contains('ativo');
    aplicarMascaraPlaca('perdi-placa', isComum);
  });

  // ‚úÖ Salvar placa encontrada (compat√≠vel com o App)
  document.getElementById('achei-salvar').addEventListener('click', async () => {
    const isComum = document.getElementById('btn-achei-comum').classList.contains('ativo');
    const placa = document.getElementById('achei-placa').value.toUpperCase().trim();
    const nome = document.getElementById('achei-nome').value.trim();
    const telefone = document.getElementById('achei-telefone').value.trim();
    const uf = document.getElementById('achei-uf').value;
    const cidade = document.getElementById('achei-municipio').value;

    const result = document.getElementById('achei-result');
    result.className = "result";
    result.innerHTML = "";

    if (!placa || !nome || !telefone || (isComum && (!uf || !cidade))) {
      result.textContent = 'Preencha todos os campos obrigat√≥rios.';
      result.style.display = 'block';
      return;
    }

    const firestoreData = {
      plate: placa,
      founderName: nome,
      founderPhone: telefone,
      foundDate: serverTimestamp(),
      location: {
        uf: isComum ? uf : 'null',
        city: isComum ? cidade : 'null'
      },
      // Adicionando userId se estiver logado
      userId: auth.currentUser ? auth.currentUser.uid : null
    };

    const keyRealtime = isComum
      ? `${placa}:${uf}:${cidade}`
      : `${placa}:null:null`;

    try {
      await addDoc(collection(firestore, 'foundPlates'), firestoreData);
      await set(ref(realtimeDb, keyRealtime), true);

      result.textContent = 'Placa cadastrada com sucesso!';
      result.style.display = 'block';

      // Limpar campos
      document.getElementById('achei-placa').value = '';
      document.getElementById('achei-nome').value = '';
      document.getElementById('achei-telefone').value = '';
      if (isComum) {
        document.getElementById('achei-uf').value = '';
        document.getElementById('achei-municipio').innerHTML = '<option value="" disabled selected>Selecione o munic√≠pio</option>';
      }
    } catch (error) {
      console.error('Erro ao salvar:', error);
      result.textContent = 'Erro ao cadastrar. Tente novamente.';
      result.style.display = 'block';
    }
  });

  // ‚úÖ Verificar placa perdida (compat√≠vel com o App)
  document.getElementById('perdi-verificar').addEventListener('click', async () => {
    const isComum = document.getElementById('btn-perdi-comum').classList.contains('ativo');
    const placa = document.getElementById('perdi-placa').value.toUpperCase().trim();
    const uf = document.getElementById('perdi-uf').value;
    const cidade = document.getElementById('perdi-municipio').value;

    const result = document.getElementById('perdi-result');
    result.className = "result";
    result.innerHTML = "";

    if (!placa || (isComum && (!uf || !cidade))) {
      result.textContent = 'Preencha todos os campos obrigat√≥rios.';
      result.style.display = 'block';
      return;
    }

    const keyRealtime = isComum
      ? `${placa}:${uf}:${cidade}`
      : `${placa}:null:null`;

    try {
      const snapshot = await get(child(ref(realtimeDb), keyRealtime));

      if (snapshot.exists()) {
        const q = query(collection(firestore, 'foundPlates'), where('plate', '==', placa));
        const querySnapshot = await getDocs(q);

        if (!querySnapshot.empty) {
          const data = querySnapshot.docs[0].data();
          const nome = data.founderName;
          const telefone = data.founderPhone.replace(/\D/g, '');
          const placaFormatada = placa;

          const mensagem = `Ol√° ${nome}! Fui informado pelo SOS Placa que voc√™ localizou a placa ${placaFormatada} do meu ve√≠culo! Se ainda tiver a√≠, me avisa como posso buscar, por favor!`;
          const url = `https://wa.me/55${telefone}?text=${encodeURIComponent(mensagem)}`;

          result.innerHTML = `
            <div style="margin-bottom: 15px;">
              ‚úÖ <strong>Placa encontrada!</strong><br>
              <strong>Respons√°vel:</strong> ${nome}<br>
              <strong>Telefone:</strong> ${telefone}
            </div>
            <a href="${url}" target="_blank" style="
              display: inline-flex;
              align-items: center;
              gap: 8px;
              background-color: #25D366;
              color: white;
              padding: 10px 16px;
              border-radius: 6px;
              text-decoration: none;
              font-weight: 600;
              box-shadow: 0 2px 6px rgba(0,0,0,0.2);
            ">
              <img src="WhatsApp.png" alt="WhatsApp" style="width: 24px; height: 24px;">
              Falar no WhatsApp
            </a>
          `;
        } else {
          result.innerHTML = '‚úÖ Placa encontrada, mas dados do respons√°vel n√£o localizados.';
        }
      } else {
        result.innerHTML = `
          ‚ùå <strong>Placa n√£o localizada.</strong><br>
          Tente novamente mais tarde ou cadastre-se em nosso App para receber notifica√ß√£o assim que algu√©m a encontrar.
        `;
      }

      result.style.display = 'block';
    } catch (error) {
      console.error('Erro na verifica√ß√£o:', error);
      result.textContent = 'Erro na verifica√ß√£o. Tente novamente.';
      result.style.display = 'block';
    }
  });
</script>
