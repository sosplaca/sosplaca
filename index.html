<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SOS PLACA</title>
  <link rel="icon" type="image/png" href="logo.png">
  <style>
    @font-face { font-family: 'JostBold'; src: url('jostbold.ttf') format('truetype'); }
    @font-face { font-family: 'JostMedium'; src: url('jostmedium.ttf') format('truetype'); }
    @font-face { font-family: 'JostRegular'; src: url('jostregular.ttf') format('truetype'); }
    @font-face { font-family: 'UrbanistBold'; src: url('urbanistbold.ttf') format('truetype'); }
    @font-face { font-family: 'UrbanistRegular'; src: url('urbanistregular.ttf') format('truetype'); }

    * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'JostRegular', sans-serif; }

    body { background-color: #FAFAFA; color: #333; line-height: 1.6; }

    .container { max-width: 900px; margin: 0 auto; padding: 20px; }

    header {
      background-color: #0077B6;
      color: #fff;
      padding: 1.25rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-radius: 0 0 10px 10px;
    }

    .logo-container { display: flex; align-items: center; gap: 10px; }
    .logo-img { width: 50px; height: 50px; }
    .logo-text { font-size: 2rem; font-family: 'JostBold'; }
    h1 { font-size: 1.2rem; }

    .screen {
      background-color: #fff;
      padding: 1.5rem;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-bottom: 1.25rem;
      display: none;
    }

    .screen.active { display: block; }

    .btn {
      display: inline-block;
      background-color: #023E8A;
      color: #fff;
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1rem;
      margin: 0.625rem 0.3125rem;
    }

    .btn-success { background-color: #F8961E; }
    .btn-secondary { background-color: #ADB5BD; }
    .btn-danger { background-color: #e74c3c; }

    .form-group { margin-bottom: 1.25rem; }
    label { display: block; margin-bottom: 0.5rem; font-weight: 500; }
    input, select {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 1rem;
    }

    .result {
      margin-top: 1.25rem;
      padding: 0.9375rem;
      border-radius: 6px;
      background-color: #f8f9fa;
      display: none;
    }
    .result.success { display: block; border-left: 6px solid #27ae60; }
    .result.error { display: block; border-left: 6px solid #e74c3c; }

    .alert-box {
      background-color: #fff8e1;
      border-left: 6px solid #f1c40f;
      padding: 15px;
      margin-bottom: 20px;
      border-radius: 6px;
    }

    footer {
      background-color: #023E8A;
      color: white;
      padding: 15px;
      text-align: center;
      border-radius: 10px 10px 0 0;
      margin-top: 30px;
    }

    .user-plates { margin-top: 20px; }
    .plate-card {
      background: #fff;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 10px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .profile-info {
      background: #fff;
      border-radius: 8px;
      padding: 20px;
      margin-top: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    @media (max-width:600px) {
      header { flex-direction: column; gap: 10px; }
      h1 { text-align: center; }
    }
  </style>
</head>
<body>
  <header>
    <div class="logo-container">
      <img src="logo.png" alt="Logo SOS Placa" class="logo-img">
      <div class="logo-text">SOS PLACA</div>
    </div>
    <h1>Se achou, avise! Se perdeu, procure aqui!</h1>
    <a href="https://play.google.com/store/apps/details?id=fabricioramosdasilva.sos_placa" target="_blank">
      <img src="GooglePlay.png" alt="Baixar na Google Play" style="height: 90px;">
    </a>
  </header>
  <div class="container">
    <!-- Menu Inicial -->
    <div id="menu-screen" class="screen active">
      <h2>O que você deseja fazer?</h2>
      <button id="btn-placas" class="btn">Buscar/Cadastrar Placas</button>
      <button id="btn-minhas-placas" class="btn">Minhas Placas</button>
      <button id="btn-perfil" class="btn">Meu Perfil</button>
    </div>

    <!-- Tela Buscar/Cadastrar Placas -->
    <div id="placas-screen" class="screen">
      <h2>Buscar/Cadastrar Placas</h2>
      <button id="btn-perdi" class="btn">Perdi uma placa</button>
      <button id="btn-achei" class="btn">Achei uma placa</button>
      <button class="btn btn-secondary" onclick="voltarMenu()">Voltar</button>
    </div>

    <!-- Tela Login -->
    <div id="login-screen" class="screen">
      <h2>Login</h2>
      <div class="form-group">
        <label for="login-email">E-mail:</label>
        <input type="email" id="login-email" placeholder="Digite seu e-mail" required>
      </div>
      <div class="form-group">
        <label for="login-senha">Senha:</label>
        <input type="password" id="login-senha" placeholder="Digite sua senha" required>
      </div>
      <button id="btn-login" class="btn btn-success">Entrar</button>
      <button id="btn-ir-cadastro" class="btn">Não tem conta? Cadastre-se</button>
      <button class="btn btn-secondary" onclick="voltarMenu()">Voltar</button>
      <div id="login-result" class="result"></div>
    </div>

    <!-- Tela Cadastro -->
    <div id="cadastro-screen" class="screen">
      <h2>Cadastro</h2>
      <div class="form-group">
        <label for="cadastro-nome">Nome Completo:</label>
        <input type="text" id="cadastro-nome" placeholder="Digite seu nome completo" required>
      </div>
      <div class="form-group">
        <label for="cadastro-email">E-mail:</label>
        <input type="email" id="cadastro-email" placeholder="Digite seu e-mail" required>
      </div>
      <div class="form-group">
        <label for="cadastro-telefone">Telefone:</label>
        <input type="tel" id="cadastro-telefone" placeholder="(00) 00000-0000" required>
      </div>
      <div class="form-group">
        <label for="cadastro-senha">Senha:</label>
        <input type="password" id="cadastro-senha" placeholder="Digite sua senha" required>
      </div>
      <div class="form-group">
        <label for="cadastro-confirmar-senha">Confirmar Senha:</label>
        <input type="password" id="cadastro-confirmar-senha" placeholder="Confirme sua senha" required>
      </div>
      <button id="btn-cadastrar" class="btn btn-success">Cadastrar</button>
      <button class="btn btn-secondary" onclick="voltarMenu()">Voltar</button>
      <div id="cadastro-result" class="result"></div>
    </div>
    <!-- Tela Perdi uma Placa -->
    <div id="perdi-screen" class="screen">
      <h2>Perdi uma Placa</h2>
      <div class="form-group">
        <label for="perdi-tipo">Tipo de Placa:</label>
        <select id="perdi-tipo">
          <option value="comum">Comum</option>
          <option value="mercosul">Mercosul</option>
        </select>
      </div>
      <div class="form-group">
        <label for="perdi-placa">Número da Placa:</label>
        <input type="text" id="perdi-placa" placeholder="Ex: ABC1234 ou ABC1D23">
      </div>
      <div class="form-group">
        <label for="perdi-uf">Estado (UF):</label>
        <select id="perdi-uf"></select>
      </div>
      <div class="form-group">
        <label for="perdi-municipio">Município:</label>
        <select id="perdi-municipio"></select>
      </div>
      <button id="perdi-verificar" class="btn btn-success">Verificar Placa</button>
      <button class="btn btn-secondary" onclick="voltarMenu()">Voltar</button>
      <div id="perdi-result" class="result"></div>
    </div>

    <!-- Tela Achei uma Placa -->
    <div id="achei-screen" class="screen">
      <h2>Achei uma Placa</h2>
      <div class="form-group">
        <label for="achei-tipo">Tipo de Placa:</label>
        <select id="achei-tipo">
          <option value="comum">Comum</option>
          <option value="mercosul">Mercosul</option>
        </select>
      </div>
      <div class="form-group">
        <label for="achei-placa">Número da Placa:</label>
        <input type="text" id="achei-placa" placeholder="Ex: ABC1234 ou ABC1D23">
      </div>
      <div class="form-group">
        <label for="achei-uf">Estado (UF):</label>
        <select id="achei-uf"></select>
      </div>
      <div class="form-group">
        <label for="achei-municipio">Município:</label>
        <select id="achei-municipio"></select>
      </div>
      <div class="form-group">
        <label for="achei-nome">Seu nome:</label>
        <input type="text" id="achei-nome" placeholder="Digite seu nome">
      </div>
      <div class="form-group">
        <label for="achei-telefone">Telefone para contato:</label>
        <input type="tel" id="achei-telefone" placeholder="(00) 00000-0000">
      </div>
      <button id="achei-salvar" class="btn btn-success">Salvar Placa</button>
      <button class="btn btn-secondary" onclick="voltarMenu()">Voltar</button>
      <div id="achei-result" class="result"></div>
    </div>
    <!-- Tela Minhas Placas -->
    <div id="minhas-placas-screen" class="screen">
      <h2>Minhas Placas</h2>
      <div id="minhas-placas-content"></div>
      <button class="btn btn-secondary" onclick="voltarMenu()">Voltar</button>
    </div>

    <!-- Tela Meu Perfil -->
    <div id="perfil-screen" class="screen">
      <h2>Meu Perfil</h2>
      <div id="perfil-content"></div>
      <button class="btn btn-secondary" onclick="voltarMenu()">Voltar</button>
    </div>

    <footer>
      <p>&copy; 2025 SOS PLACA - Todos os direitos reservados.</p>
    </footer>
  </div> <!-- Fecha .container -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword,
      signOut
    } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";
    import {
      getFirestore,
      collection,
      query,
      where,
      getDocs,
      addDoc,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";
    import {
      getDatabase,
      ref,
      set
    } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBn6cCXLnU6LUH7kOjVtvpuceQ2lVzzczg",
      authDomain: "sosplaca-73cf7.firebaseapp.com",
      projectId: "sosplaca-73cf7",
      storageBucket: "sosplaca-73cf7.appspot.com",
      messagingSenderId: "658059385722",
      appId: "1:658059385722:web:202e84abf6dcc6fbd894c3",
      databaseURL: "https://sosplaca-73cf7-default-rtdb.firebaseio.com"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth();
    const firestore = getFirestore();
    const realtimeDb = getDatabase();
    // Funções utilitárias
    function mostrarTela(id) {
      document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
      document.getElementById(id).classList.add('active');
    }

    function voltarMenu() {
      mostrarTela('menu-screen');
    }

    // Estado do usuário
    onAuthStateChanged(auth, (user) => {
      if (user) {
        carregarMinhasPlacas(user.uid);
      }
    });

    // Cadastro
    btnCadastrar.onclick = async () => {
      const nome = cadastroNome.value.trim();
      const email = cadastroEmail.value.trim();
      const telefone = cadastroTelefone.value.trim();
      const senha = cadastroSenha.value;
      const confirmar = cadastroConfirmarSenha.value;
      if (senha !== confirmar) {
        cadastroResult.textContent = "Senhas diferentes.";
        cadastroResult.className = "result error";
        cadastroResult.style.display = "block";
        return;
      }
      try {
        const cred = await createUserWithEmailAndPassword(auth, email, senha);
        await addDoc(collection(firestore, "users"), {
          uid: cred.user.uid,
          name: nome,
          email: email,
          phone: telefone
        });
        mostrarTela('menu-screen');
      } catch (error) {
        cadastroResult.textContent = "Erro: " + error.message;
        cadastroResult.className = "result error";
        cadastroResult.style.display = "block";
      }
    };

    // Login
    btnLogin.onclick = async () => {
      try {
        await signInWithEmailAndPassword(auth, loginEmail.value, loginSenha.value);
        mostrarTela('menu-screen');
      } catch (error) {
        loginResult.textContent = "Erro: " + error.message;
        loginResult.className = "result error";
        loginResult.style.display = "block";
      }
    };

    // Logout
    function fazerLogout() {
      signOut(auth).then(() => mostrarTela('menu-screen'));
    }

    // Carregar Perfil
    async function carregarPerfil(uid) {
      const q = query(collection(firestore, "users"), where("uid", "==", uid));
      const snapshot = await getDocs(q);
      if (!snapshot.empty) {
        const userData = snapshot.docs[0].data();
        perfilContent.innerHTML = `
          <div class="profile-info">
            <p><strong>Nome:</strong> ${userData.name}</p>
            <p><strong>E-mail:</strong> ${userData.email}</p>
            <p><strong>Telefone:</strong> ${userData.phone}</p>
            <button onclick="fazerLogout()" class="btn btn-danger">Sair</button>
          </div>`;
      } else {
        perfilContent.innerHTML = "<p>Perfil não encontrado.</p>";
      }
    }

    // Carregar Minhas Placas
    async function carregarMinhasPlacas(uid) {
      const content = document.getElementById("minhas-placas-content");
      content.innerHTML = "<p>Carregando...</p>";
      const q = query(collection(firestore, "foundPlates"), where("uid", "==", uid));
      const snapshot = await getDocs(q);
      if (snapshot.empty) {
        content.innerHTML = "<p>Você ainda não cadastrou nenhuma placa.</p>";
        return;
      }
      let html = '';
      snapshot.forEach(doc => {
        const data = doc.data();
        html += `
          <div class="plate-card">
            <p><strong>Placa:</strong> ${data.plate}</p>
            <p><strong>UF:</strong> ${data.uf} - <strong>Cidade:</strong> ${data.city}</p>
            <p><strong>Data:</strong> ${data.createdAt ? new Date(data.createdAt.toDate()).toLocaleDateString() : 'N/A'}</p>
          </div>`;
      });
      content.innerHTML = html;
    }

    // Navegação entre telas
    btnPlacas.onclick = () => mostrarTela('placas-screen');
    btnMinhasPlacas.onclick = () => auth.currentUser ? mostrarTela('minhas-placas-screen') : mostrarTela('login-screen');
    btnPerfil.onclick = () => auth.currentUser ? (carregarPerfil(auth.currentUser.uid), mostrarTela('perfil-screen')) : mostrarTela('login-screen');
    btnIrCadastro.onclick = () => mostrarTela('cadastro-screen');

    // Função Verificar Placa
    document.getElementById("perdi-verificar").addEventListener("click", async () => {
      const placa = document.getElementById("perdi-placa").value.trim().toUpperCase();
      const result = document.getElementById("perdi-result");
      result.className = "result";
      result.style.display = "none";

      if (!placa) {
        result.textContent = "Digite uma placa.";
        result.classList.add("error");
        result.style.display = "block";
        return;
      }

      try {
        const q = query(collection(firestore, "foundPlates"), where("plate", "==", placa));
        const snapshot = await getDocs(q);
        if (snapshot.empty) {
          result.textContent = "Nenhum registro encontrado para essa placa.";
          result.classList.add("error");
        } else {
          const data = snapshot.docs[0].data();
          const nome = data.name || "Pessoa não identificada";
          const telefone = data.phone || "";
          let msg = `Placa encontrada! Responsável: ${nome}`;
          if (/^\\(?\\d{2}\\)?\\s?\\d{5}-?\\d{4}$/.test(telefone)) {
            const link = `https://wa.me/55${telefone.replace(/\\D/g, '')}?text=Olá! Vi no SOS Placa que você encontrou minha placa: ${placa}`;
            msg += `<br><a href=\"${link}\" target=\"_blank\">Falar via WhatsApp</a>`;
          }
          result.innerHTML = msg;
          result.classList.add("success");
        }
        result.style.display = "block";
      } catch (error) {
        console.error("Erro na verificação:", error);
        result.textContent = "Erro ao consultar a placa.";
        result.classList.add("error");
        result.style.display = "block";
      }
    });

    // Função Salvar Placa
    document.getElementById("achei-salvar").addEventListener("click", async () => {
      const placa = document.getElementById("achei-placa").value.trim().toUpperCase();
      const tipo = document.getElementById("achei-tipo").value;
      const uf = document.getElementById("achei-uf").value;
      const municipio = document.getElementById("achei-municipio").value;
      const nome = document.getElementById("achei-nome").value.trim();
      const telefone = document.getElementById("achei-telefone").value.trim();
      const result = document.getElementById("achei-result");

      result.className = "result";
      result.style.display = "none";

      if (!placa || !tipo || !uf || !municipio || !nome || !telefone) {
        result.textContent = "Preencha todos os campos.";
        result.classList.add("error");
        result.style.display = "block";
        return;
      }

      try {
        await addDoc(collection(firestore, "foundPlates"), {
          plate: placa,
          type: tipo,
          uf: uf,
          city: municipio,
          name: nome,
          phone: telefone,
          uid: auth.currentUser ? auth.currentUser.uid : null,
          createdAt: serverTimestamp()
        });

        const realtimePath = `${placa}:null:null:true`;
        await set(ref(realtimeDb, realtimePath), true);

        result.textContent = "Placa cadastrada com sucesso!";
        result.classList.add("success");
        result.style.display = "block";
      } catch (error) {
        console.error("Erro ao salvar:", error);
        result.textContent = "Erro ao salvar a placa.";
        result.classList.add("error");
        result.style.display = "block";
      }
    });
  </script>
</body>
</html>
