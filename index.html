<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SOS PLACA</title>
  <link rel="icon" type="image/png" href="logo.png">

  <!-- Estilos e fontes omitidos aqui para economizar espaço -->

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getFirestore, collection, addDoc, serverTimestamp, getDocs, query, where } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut, createUserWithEmailAndPassword, updateProfile } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
    import { getDatabase, ref, set, get, child } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBjetihGmlo_z01jx-GW9Ith0oDCS0jwYc",
      authDomain: "sosplaca-73cf7.firebaseapp.com",
      databaseURL: "https://sosplaca-73cf7-default-rtdb.firebaseio.com",
      projectId: "sosplaca-73cf7",
      storageBucket: "sosplaca-73cf7.appspot.com",
      messagingSenderId: "658059385722",
      appId: "1:658059385722:web:5ed0e8fd7f7a2931d894c3"
    };

    const app = initializeApp(firebaseConfig);
    const firestore = getFirestore(app);
    const realtimeDb = getDatabase(app);
    const auth = getAuth(app);

    let usuarioAtual = null;

    onAuthStateChanged(auth, user => {
      usuarioAtual = user;
      atualizarInterfaceUsuario();
    });

    function atualizarInterfaceUsuario() {
      const menu = document.getElementById("menu-screen");
      const btnMinhas = document.getElementById("btn-minhas");
      const btnPerfil = document.getElementById("btn-perfil");

      if (usuarioAtual) {
        btnMinhas.style.display = 'inline-block';
        btnPerfil.style.display = 'inline-block';
      } else {
        btnMinhas.style.display = 'none';
        btnPerfil.style.display = 'inline-block';
      }
    }

    window.sairDoSistema = () => {
      signOut(auth).then(() => mostrarTela('menu-screen'));
    };

    window.loginComEmail = async () => {
      const email = document.getElementById("login-email").value.trim();
      const senha = document.getElementById("login-senha").value;
      const erro = document.getElementById("login-erro");
      erro.textContent = '';

      try {
        await signInWithEmailAndPassword(auth, email, senha);
        mostrarTela('menu-screen');
      } catch (e) {
        erro.textContent = "Erro ao entrar: " + e.message;
      }
    };

    window.registrarUsuario = async () => {
      const nome = document.getElementById("reg-nome").value.trim();
      const email = document.getElementById("reg-email").value.trim();
      const telefone = document.getElementById("reg-telefone").value.trim();
      const senha = document.getElementById("reg-senha").value;
      const confirma = document.getElementById("reg-confirma").value;
      const erro = document.getElementById("reg-erro");
      erro.textContent = '';

      if (senha !== confirma) {
        erro.textContent = "As senhas não coincidem.";
        return;
      }

      try {
        const cred = await createUserWithEmailAndPassword(auth, email, senha);
        await updateProfile(cred.user, { displayName: nome });

        await set(ref(realtimeDb, `users/${cred.user.uid}`), {
          nome,
          email,
          telefone
        });

        mostrarTela('menu-screen');
      } catch (e) {
        erro.textContent = "Erro ao registrar: " + e.message;
      }
    };
  </script>
</head>
<body>

<header>
  <div class="logo-container">
    <img src="logo.png" alt="Logo SOS Placa" class="logo-img">
    <div class="logo-text">SOS PLACA</div>
  </div>
  <h1>Se achou, avise! Se perdeu, procure aqui!</h1>
  <a href="https://play.google.com/store/apps/details?id=fabricioramosdasilva.sos_placa" target="_blank">
    <img src="GooglePlay.png" alt="Baixar na Google Play" style="height: 90px;">
  </a>
</header>

<div class="container">

  <!-- MENU PRINCIPAL -->
  <div id="menu-screen" class="screen active">
    <h2>O que você deseja fazer?</h2>
    <button id="btn-perdi" class="btn">Perdi uma placa</button>
    <button id="btn-achei" class="btn">Achei uma placa</button>
    <button id="btn-minhas" class="btn" style="display:none;" onclick="mostrarTela('minhas-placas-screen')">Minhas Placas</button>
    <button id="btn-perfil" class="btn" onclick="mostrarTela('perfil-screen')">Perfil</button>
  </div>

  <!-- TELA DE LOGIN -->
  <div id="login-screen" class="screen">
    <h2>Entre com sua conta!</h2>
    <div class="form-group">
      <label for="login-email">E-mail:</label>
      <input type="email" id="login-email" required>
    </div>
    <div class="form-group">
      <label for="login-senha">Senha:</label>
      <input type="password" id="login-senha" required>
    </div>
    <button class="btn btn-success" onclick="loginComEmail()">Entrar</button>
    <button class="btn btn-secondary" onclick="voltarMenu()">Voltar</button>
    <p style="margin-top: 1rem;">Não tem uma conta? <a href="#" onclick="mostrarTela('register-screen')">Crie uma aqui!</a></p>
    <p id="login-erro" class="result error" style="display:block;"></p>
  </div>

  <!-- TELA DE REGISTRO -->
  <div id="register-screen" class="screen">
    <h2>Crie sua conta</h2>
    <div class="form-group">
      <label for="reg-nome">Nome completo:</label>
      <input type="text" id="reg-nome" required>
    </div>
    <div class="form-group">
      <label for="reg-email">E-mail:</label>
      <input type="email" id="reg-email" required>
    </div>
    <div class="form-group">
      <label for="reg-telefone">Telefone:</label>
      <input type="tel" id="reg-telefone" required>
    </div>
    <div class="form-group">
      <label for="reg-senha">Senha:</label>
      <input type="password" id="reg-senha" required>
    </div>
    <div class="form-group">
      <label for="reg-confirma">Confirmar senha:</label>
      <input type="password" id="reg-confirma" required>
    </div>
    <button class="btn btn-success" onclick="registrarUsuario()">Registrar-se</button>
    <button class="btn btn-secondary" onclick="mostrarTela('login-screen')">Voltar</button>
    <p id="reg-erro" class="result error" style="display:block;"></p>
  </div>

  <!-- TELA DE PERFIL -->
  <div id="perfil-screen" class="screen">
    <h2>Perfil do Usuário</h2>
    <div id="perfil-dados">
      <!-- Populado por JavaScript -->
    </div>
    <div style="margin-top:1rem;">
      <button class="btn btn-secondary" onclick="voltarMenu()">Voltar</button>
      <button class="btn btn-success" onclick="sairDoSistema()">Sair</button>
    </div>
  </div>

  <!-- TELA MINHAS PLACAS -->
  <div id="minhas-placas-screen" class="screen">
    <h2>Minhas Placas</h2>
    <div id="lista-minhas-placas">
      <!-- Populado dinamicamente -->
    </div>
    <button class="btn btn-secondary" onclick="voltarMenu()">Voltar</button>
  </div>
<script type="module">
  // Referências reutilizadas
  import { getFirestore, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";
  import { getDatabase, ref, get, child } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";
  import { getAuth } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";

  const auth = getAuth();
  const firestore = getFirestore();
  const database = getDatabase();

  // Mostrar dados do perfil
  window.mostrarTela = async function(id) {
    document.querySelectorAll('.screen').forEach(screen => screen.classList.remove('active'));
    document.getElementById(id).classList.add('active');

    if (id === 'perfil-screen') {
      const perfilDiv = document.getElementById("perfil-dados");
      if (auth.currentUser) {
        const uid = auth.currentUser.uid;
        const snap = await get(child(ref(database), `users/${uid}`));
        const dados = snap.val();
        perfilDiv.innerHTML = `
          <p><strong>Nome:</strong> ${dados?.nome || auth.currentUser.displayName || '–'}</p>
          <p><strong>Email:</strong> ${auth.currentUser.email}</p>
          <p><strong>Telefone:</strong> ${dados?.telefone || '–'}</p>
        `;
      } else {
        perfilDiv.innerHTML = `<p>Você não está logado.</p>
          <button class="btn btn-success" onclick="mostrarTela('login-screen')">Fazer login</button>`;
      }
    }

    if (id === 'minhas-placas-screen') {
      await carregarMinhasPlacas();
    }
  };

  // Carregar placas ligadas ao usuário
  async function carregarMinhasPlacas() {
    const container = document.getElementById("lista-minhas-placas");
    container.innerHTML = "";

    if (!auth.currentUser) {
      container.innerHTML = "<p>Você precisa estar logado.</p>";
      return;
    }

    const uid = auth.currentUser.uid;
    const q = query(collection(firestore, "foundPlates"), where("uid", "==", uid));
    const res = await getDocs(q);

    if (res.empty) {
      container.innerHTML = "<p>Nenhuma placa cadastrada por você foi localizada.</p>";
      return;
    }

    res.forEach(doc => {
      const placa = doc.data().plate;
      const div = document.createElement("div");
      div.style.marginBottom = "1rem";

      verificarStatusDaPlaca(placa).then(({ encontrada, detalhesHTML }) => {
        const cor = encontrada ? "#2ecc71" : "#e74c3c";
        const textoBotao = encontrada ? "Toque para mais detalhes" : "Não encontrada";
        const msgAoClicar = encontrada ? detalhesHTML : `<p>Essa placa ainda não foi localizada.</p>`;

        div.innerHTML = `
          <div style="border:1px solid #ccc; border-radius:6px; padding:10px;">
            <p><strong>Placa:</strong> ${placa}</p>
            <button class="btn" style="background-color:${cor}; width:100%;" onclick="mostrarDetalhesPlaca('${msgAoClicar.replace(/'/g, "\\'")}')">${textoBotao}</button>
          </div>
        `;
        container.appendChild(div);
      });
    });
  }

  window.mostrarDetalhesPlaca = function(msg) {
    const container = document.getElementById("lista-minhas-placas");
    const div = document.createElement("div");
    div.className = "result success";
    div.style.marginTop = "1rem";
    div.innerHTML = msg;
    container.appendChild(div);
  };

  async function verificarStatusDaPlaca(placa) {
    const q = query(collection(firestore, "foundPlates"), where("plate", "==", placa));
    const res = await getDocs(q);

    if (!res.empty) {
      const dados = res.docs[0].data();
      const nome = dados.founderName || "–";
      const telefone = dados.founderPhone || "–";
      const soNumeros = telefone.replace(/\D/g, "");
      const ehCelular = soNumeros.length >= 10 && soNumeros.length <= 11 && soNumeros.slice(-9, -8) === '9';
      const mensagem = encodeURIComponent(`Olá ${nome}! Vi que vc cadastrou a placa ${placa} no SOS Placa – ela é do meu veículo! Se ainda tiver aí, me avisa como posso buscar, por favor!`);
      const whatsappLink = ehCelular ? `<a href="https://wa.me/55${soNumeros}?text=${mensagem}" target="_blank"><img src="WhatsApp.png" alt="WhatsApp" style="height: 50px; margin-top: 10px;"></a>` : "";
      const html = `<p><strong>Boa notícia!</strong> A placa <strong>${placa}</strong> foi encontrada por <strong>${nome}</strong>.</p>${whatsappLink}`;
      return { encontrada: true, detalhesHTML: html };
    }

    return { encontrada: false, detalhesHTML: "" };
  }
</script>
<script type="module">
  import { getFirestore, collection, addDoc, query, where, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";
  import { getAuth } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";

  const firestore = getFirestore();
  const auth = getAuth();

  const btnVerificar = document.getElementById("perdi-verificar");
  btnVerificar.addEventListener("click", async () => {
    const placaInput = document.getElementById("perdi-placa").value.trim().toUpperCase().replace(/[^A-Z0-9]/g, "");
    if (!placaInput) return;

    const resultDiv = document.getElementById("perdi-result");
    resultDiv.className = "result";
    resultDiv.innerHTML = "";

    try {
      const colRef = collection(firestore, "foundPlates");
      const q = query(colRef, where("plate", "==", placaInput));
      const snapshot = await getDocs(q);

      if (snapshot.empty) {
        resultDiv.classList.add("error");
        resultDiv.innerHTML = `<p>Infelizmente ainda não encontramos essa placa. Mas continue tentando, ela pode aparecer a qualquer momento!</p>`;

        if (auth.currentUser) {
          // Verifica se já existe alerta dessa placa para esse usuário
          const alertQuery = query(collection(firestore, "alerts"), where("plate", "==", placaInput), where("uid", "==", auth.currentUser.uid));
          const existing = await getDocs(alertQuery);
          if (existing.empty) {
            await addDoc(collection(firestore, "alerts"), {
              uid: auth.currentUser.uid,
              plate: placaInput,
              createdAt: serverTimestamp()
            });
            resultDiv.innerHTML += `<p style="margin-top:1rem;"><strong>🔔 Alerta ativado:</strong> você será avisado quando essa placa for encontrada!</p>`;
          }
        } else {
          resultDiv.innerHTML += `<p style="margin-top:1rem;">Se quiser receber um alerta automático quando a placa for localizada, <a href="#" onclick="mostrarTela('login-screen')">faça login</a>.</p>`;
        }

        return;
      }

      // Encontrada
      let html = "";
      snapshot.forEach(doc => {
        const dados = doc.data();
        const nome = dados.founderName || "";
        const telefone = dados.founderPhone || "";
        const soNumeros = telefone.replace(/\D/g, "");
        const ehCelular = soNumeros.length >= 10 && soNumeros.length <= 11 && soNumeros.slice(-9, -8) === '9';

        html += `<p><strong>Boa notícia!</strong> A placa <strong>${placaInput}</strong> foi encontrada por <strong>${nome}</strong>.</p>`;

        if (ehCelular) {
          const mensagem = encodeURIComponent(`Olá ${nome}! Vi que vc cadastrou a placa ${placaInput} no SOS Placa – ela é do meu veículo! Se ainda tiver aí, me avisa como posso buscar, por favor!`);
          html += `<a href="https://wa.me/55${soNumeros}?text=${mensagem}" target="_blank"><img src="WhatsApp.png" alt="WhatsApp" style="height: 50px; margin-top: 10px;"></a>`;
        }
      });

      resultDiv.classList.add("success");
      resultDiv.innerHTML = html;

    } catch (error) {
      console.error("Erro ao buscar placa:", error);
      resultDiv.classList.add("error");
      resultDiv.innerHTML = `<p>Houve um erro ao verificar a placa. Tente novamente em instantes.</p>`;
    }
  });
</script>
</div> <!-- Fim da .container -->

<footer>
  &copy; 2025 SOS PLACA – Todos os direitos reservados.
</footer>

<script>
  // Alternância entre telas
  function voltarMenu() {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById('menu-screen').classList.add('active');
  }

  // Botões principais
  document.getElementById("btn-perdi").addEventListener("click", () => mostrarTela("perdi-screen"));
  document.getElementById("btn-achei").addEventListener("click", () => mostrarTela("achei-screen"));
</script>

</body>
</html>
