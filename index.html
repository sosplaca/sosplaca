<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SOS PLACA</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Roboto', sans-serif; }
    body { background-color: #f5f5f5; color: #333; line-height: 1.6; }
    .container { max-width: 900px; margin: 0 auto; padding: 20px; }
    header { background-color: #2c3e50; color: #fff; padding: 1.25rem; text-align: center; border-radius: 0 0 0.625rem 0.625rem; }
    .logo { font-size: 2.5rem; font-weight: bold; }
    .screen { background-color: #fff; padding: 1.5rem; border-radius: 0.625rem; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 1.25rem; display: none; }
    .screen.active { display: block; }
    .btn { display: inline-block; background-color: #3498db; color: #fff; padding: 0.75rem 1.5rem; border: none; border-radius: 0.3125rem; cursor: pointer; font-size: 1rem; margin: 0.625rem 0.3125rem; }
    .btn-success { background-color: #27ae60; }
    .btn-secondary { background-color: #95a5a6; }
    .form-group { margin-bottom: 1.25rem; }
    label { display: block; margin-bottom: 0.5rem; font-weight: 500; }
    input, select { width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 0.3125rem; font-size: 1rem; }
    .result { margin-top: 1.25rem; padding: 0.9375rem; border-radius: 0.3125rem; background-color: #f8f9fa; display: none; }
    .result.success { display: block; border-left: 4px solid #27ae60; }
    @media (max-width:600px) {
      .container { padding: 0.625rem; }
      .btn { padding: 0.625rem 0.9375rem; }
    }
  </style>
</head>
<body>
<header>
  <div class="container">
    <div class="logo">SOS PLACA</div>
    <h1>Ajude a reunir placas perdidas com seus donos</h1>
  </div>
</header>

<div class="container">
  <div id="error-message" class="result error" style="display:none;"></div>
  <div id="success-message" class="result success" style="display:none;"></div>

  <!-- Tela inicial -->
  <div id="home-screen" class="screen active">
    <h2>O que você deseja fazer?</h2>
    <button id="perdi-btn" class="btn">Perdi uma placa</button>
    <button id="achei-btn" class="btn btn-success">Achei uma placa</button>
  </div>

  <!-- Tela Achei -->
  <div id="achei-screen" class="screen">
    <h2>Cadastrar placa encontrada</h2>
    <div class="form-group">
      <label>Tipo de placa:</label>
      <div style="display: flex; gap: 0.625rem;">
        <button id="btn-achei-comum" class="btn ativo">Comum</button>
        <button id="btn-achei-mercosul" class="btn">Mercosul</button>
      </div>
    </div>
    <div class="form-group">
      <label for="achei-placa">Número da placa:</label>
      <input type="text" id="achei-placa" placeholder="AAA-0000 ou AAA0A00" required>
    </div>
    <div class="form-group" id="achei-localizacao">
      <label for="achei-uf">UF:</label>
      <select id="achei-uf" required>
        <option value="" disabled selected>Selecione o estado</option>
      </select>
      <label for="achei-municipio">Município:</label>
      <select id="achei-municipio" required>
        <option value="" disabled selected>Selecione o município</option>
      </select>
    </div>
    <div class="form-group">
      <label for="achei-nome">Seu nome:</label>
      <input type="text" id="achei-nome" placeholder="Digite seu nome completo" required>
    </div>
    <div class="form-group">
      <label for="achei-telefone">Seu telefone:</label>
      <input type="tel" id="achei-telefone" placeholder="(00) 00000-0000" required>
    </div>
    <div>
      <button id="achei-voltar" class="btn btn-secondary">Voltar</button>
      <button id="achei-salvar" class="btn btn-success">Salvar Placa</button>
    </div>
    <div id="achei-result" class="result"></div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
  import { getFirestore, collection, addDoc, serverTimestamp, query, where, getDocs } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";
  import { getDatabase, ref, set } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBjetihGmlo_z01jx-GW9Ith0oDCS0jwYc",
    authDomain: "sosplaca-73cf7.firebaseapp.com",
    databaseURL: "https://sosplaca-73cf7-default-rtdb.firebaseio.com",
    projectId: "sosplaca-73cf7",
    storageBucket: "sosplaca-73cf7.appspot.com",
    messagingSenderId: "658059385722",
    appId: "1:658059385722:web:5ed0e8fd7f7a2931d894c3"
  };

  const app = initializeApp(firebaseConfig);
  const firestore = getFirestore(app);
  const database = getDatabase(app);

  // Dados de estados e municípios
  const estadosMunicipios = {
    'SP': ['Ubatuba', 'Caraguatatuba'],
    'RJ': ['Paraty', 'Angra dos Reis']
  };

  // [Continuação do script da Parte 1]

  // Preencher selects de UF e municípios
  function preencherUFs() {
    const ufSelects = document.querySelectorAll('select[id$="-uf"]');
    ufSelects.forEach(select => {
      while (select.options.length > 1) select.remove(1);
      Object.keys(estadosMunicipios).forEach(uf => {
        const option = document.createElement('option');
        option.value = uf;
        option.textContent = uf;
        select.appendChild(option);
      });
      select.addEventListener('change', function() {
        const municipioSelect = this.closest('.form-group').querySelector('select[id$="-municipio"]');
        atualizarMunicipios(this.value, municipioSelect);
      });
    });
  }

  function atualizarMunicipios(uf, municipioSelect) {
    while (municipioSelect.options.length > 1) municipioSelect.remove(1);
    if (uf && estadosMunicipios[uf]) {
      estadosMunicipios[uf].forEach(municipio => {
        const option = document.createElement('option');
        option.value = municipio;
        option.textContent = municipio;
        municipioSelect.appendChild(option);
      });
    }
  }

  // Navegação entre telas
  const screens = {
    home: document.getElementById('home-screen'),
    achei: document.getElementById('achei-screen')
  };

  document.getElementById('achei-btn').addEventListener('click', () => {
    screens.home.classList.remove('active');
    screens.achei.classList.add('active');
  });

  document.getElementById('achei-voltar').addEventListener('click', () => {
    screens.achei.classList.remove('active');
    screens.home.classList.add('active');
  });

  // Máscaras de entrada
  document.getElementById('achei-telefone').addEventListener('input', function(e) {
    let value = this.value.replace(/\D/g, '').slice(0, 11);
    if (value.length > 2) value = `(${value.substring(0, 2)}) ${value.substring(2)}`;
    if (value.length > 10) value = `${value.substring(0, 10)}-${value.substring(10)}`;
    this.value = value;
  });

  // [Continuação do script da Parte 2]

  // Tipo de placa (Comum/Mercosul)
  document.querySelectorAll('#btn-achei-comum, #btn-achei-mercosul').forEach(btn => {
    btn.addEventListener('click', function() {
      document.querySelectorAll('#achei-screen .btn').forEach(b => b.classList.remove('ativo'));
      this.classList.add('ativo');
      
      const isComum = this.id === 'btn-achei-comum';
      document.getElementById('achei-placa').placeholder = isComum ? 'AAA-0000' : 'AAA0A00';
      document.getElementById('achei-localizacao').style.display = isComum ? 'block' : 'none';
    });
  });

  // Máscara para placa
  document.getElementById('achei-placa').addEventListener('input', function() {
    let value = this.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
    const isComum = document.getElementById('btn-achei-comum').classList.contains('ativo');
    
    if (isComum) {
      value = value.slice(0, 7);
      if (value.length > 3) value = `${value.slice(0, 3)}-${value.slice(3)}`;
    } else {
      value = value.slice(0, 7);
    }
    this.value = value;
  });

  // Cadastrar placa encontrada
  document.getElementById('achei-salvar').addEventListener('click', async () => {
    const isComum = document.getElementById('btn-achei-comum').classList.contains('ativo');
    const placa = document.getElementById('achei-placa').value.toUpperCase().replace(/-/g, '');
    const nome = document.getElementById('achei-nome').value.trim();
    const telefone = document.getElementById('achei-telefone').value.replace(/\D/g, '');

    if (!placa || !nome || !telefone || (isComum && (!document.getElementById('achei-uf').value || !document.getElementById('achei-municipio').value))) {
      document.getElementById('achei-result').textContent = 'Preencha todos os campos corretamente.';
      document.getElementById('achei-result').style.display = 'block';
      return;
    }

    const plateData = {
      plate: placa,
      founderName: nome,
      founderPhone: telefone,
      timestamp: serverTimestamp(),
      ...(isComum && {
        location: {
          uf: document.getElementById('achei-uf').value,
          city: document.getElementById('achei-municipio').value
        }
      })
    };

    try {
      // Verifica se já existe cadastro igual
      const querySnapshot = await getDocs(
        query(
          collection(firestore, 'foundPlates'),
          where('plate', '==', placa),
          where('founderPhone', '==', telefone)
        )
      );

      if (querySnapshot.empty) {
        await addDoc(collection(firestore, 'foundPlates'), plateData);
        await set(ref(database, `foundPlates/${placa}`), plateData);
        
        document.getElementById('achei-result').textContent = 'Placa cadastrada com sucesso!';
        document.getElementById('achei-result').style.display = 'block';
        
        // Limpa o formulário
        document.getElementById('achei-placa').value = '';
        document.getElementById('achei-nome').value = '';
      } else {
        document.getElementById('achei-result').textContent = 'Esta placa já foi cadastrada por este telefone.';
        document.getElementById('achei-result').style.display = 'block';
      }
    } catch (error) {
      console.error('Erro ao cadastrar:', error);
      document.getElementById('achei-result').textContent = 'Erro ao cadastrar placa. Tente novamente.';
      document.getElementById('achei-result').style.display = 'block';
    }
  });

  // Inicialização
  document.addEventListener('DOMContentLoaded', () => {
    preencherUFs();
    document.getElementById('btn-achei-comum').click();
  });
</script>
</body>
</html>
