<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Menos placas perdidas, mais gente feliz!</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Roboto', sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background-color: #2c3e50;
            color: white;
            padding: 20px 0;
            text-align: center;
            margin-bottom: 30px;
            border-radius: 0 0 10px 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            font-size: 2rem;
            margin-bottom: 10px;
        }
        
        .logo {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .screen {
            background-color: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            display: none;
        }
        
        .screen.active {
            display: block;
        }
        
        .btn {
            display: inline-block;
            background-color: #3498db;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            text-align: center;
            text-decoration: none;
            transition: background-color 0.3s;
            margin: 10px 5px;
        }
        
        .btn:hover {
            background-color: #2980b9;
        }
        
        .btn-secondary {
            background-color: #95a5a6;
        }
        
        .btn-secondary:hover {
            background-color: #7f8c8d;
        }
        
        .btn-success {
            background-color: #27ae60;
        }
        
        .btn-success:hover {
            background-color: #219653;
        }
        
        .btn-whatsapp {
            background-color: #25D366;
        }
        
        .btn-whatsapp:hover {
            background-color: #1da851;
        }
        
        .btn-danger {
            background-color: #e74c3c;
        }
        
        .btn-danger:hover {
            background-color: #c0392b;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        input, select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
        }
        
        .placa-input {
            text-transform: uppercase;
        }
        
        .placa-example {
            font-size: 0.9rem;
            color: #7f8c8d;
            margin-top: 5px;
        }
        
        .radio-group {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .radio-option {
            display: flex;
            align-items: center;
        }
        
        .radio-option input {
            width: auto;
            margin-right: 8px;
        }
        
        .placa-type-container {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-left: 25px;
        }
        
        .placa-type-image {
            width: 80px;
            height: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
            transition: opacity 0.3s;
        }
        
        .result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 5px;
            background-color: #f8f9fa;
            display: none;
        }
        
        .result.success {
            display: block;
            border-left: 4px solid #27ae60;
        }
        
        .result.error {
            display: block;
            border-left: 4px solid #e74c3c;
        }
        
        .result-info {
            margin-bottom: 10px;
        }
        
        .contato-item {
            padding: 10px;
            margin: 5px 0;
            background-color: #e8f4fc;
            border-radius: 4px;
            border-left: 3px solid #3498db;
        }
        
        .contato-info {
            margin-bottom: 5px;
        }
        
        .actions {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }
        
        footer {
            text-align: center;
            margin-top: 40px;
            padding: 20px;
            color: #7f8c8d;
            font-size: 0.9rem;
        }
        
        @media (max-width: 600px) {
            .container {
                padding: 10px;
            }
            
            .screen {
                padding: 15px;
            }
            
            .btn {
                padding: 10px 15px;
                font-size: 0.9rem;
            }
            
            .placa-type-container {
                margin-left: 0;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="logo">SOS PLACA</div>
            <h1>Menos placas perdidas, mais gente feliz!</h1>
        </div>
    </header>
    
    <div class="container">
        <!-- Tela Inicial -->
        <div id="home-screen" class="screen active">
            <h2>O que você deseja fazer?</h2>
            <p>Selecione uma opção abaixo para continuar:</p>
            
            <div class="actions">
                <button id="perdi-btn" class="btn">Perdi uma placa</button>
                <button id="achei-btn" class="btn btn-success">Achei uma placa</button>
            </div>
        </div>
        
        <!-- Tela Perdi Placa -->
        <div id="perdi-screen" class="screen">
            <h2>Buscar placa perdida</h2>
            <p>Preencha os dados da placa que você perdeu para verificar se alguém encontrou.</p>
            
            <div class="form-group">
                <label>Tipo de placa:</label>
                <div class="radio-group">
                    <div class="radio-option">
                        <input type="radio" id="perdi-tipo-comum" name="perdi-tipo-placa" value="comum" checked>
                        <label for="perdi-tipo-comum">
                            <div class="placa-type-container">
                                <img src="comum.png" alt="Placa Comum" class="placa-type-image" id="perdi-img-comum">
                                <span>Padrão antigo (ABC-1234)</span>
                            </div>
                        </label>
                    </div>
                    <div class="radio-option">
                        <input type="radio" id="perdi-tipo-mercosul" name="perdi-tipo-placa" value="mercosul">
                        <label for="perdi-tipo-mercosul">
                            <div class="placa-type-container">
                                <img src="mercosul.png" alt="Placa Mercosul" class="placa-type-image" id="perdi-img-mercosul">
                                <span>Mercosul (ABC1D23)</span>
                            </div>
                        </label>
                    </div>
                </div>
            </div>
            
            <div class="form-group">
                <label for="perdi-placa">Número da placa:</label>
                <input type="text" id="perdi-placa" class="placa-input" placeholder="Digite a placa">
                <div class="placa-example" id="perdi-placa-example">Exemplo: ABC-1234</div>
            </div>
            
            <div class="actions">
                <button id="perdi-voltar" class="btn btn-secondary">Voltar</button>
                <button id="perdi-buscar" class="btn">Buscar Placa</button>
            </div>
            
            <div id="perdi-result" class="result">
                <p id="perdi-result-text"></p>
                <div id="perdi-result-contatos"></div>
                <button id="perdi-remover-btn" class="btn btn-danger" style="display: none;">
                    Remover placa do sistema
                </button>
            </div>
        </div>
        
        <!-- Tela Achei Placa -->
        <div id="achei-screen" class="screen">
            <h2>Cadastrar placa encontrada</h2>
            <p>Preencha os dados da placa que você encontrou e vamos tentar localizar o dono.</p>
            
            <div class="form-group">
                <label>Tipo de placa:</label>
                <div class="radio-group">
                    <div class="radio-option">
                        <input type="radio" id="achei-tipo-comum" name="achei-tipo-placa" value="comum" checked>
                        <label for="achei-tipo-comum">
                            <div class="placa-type-container">
                                <img src="comum.png" alt="Placa Comum" class="placa-type-image" id="achei-img-comum">
                                <span>Padrão antigo (ABC-1234)</span>
                            </div>
                        </label>
                    </div>
                    <div class="radio-option">
                        <input type="radio" id="achei-tipo-mercosul" name="achei-tipo-placa" value="mercosul">
                        <label for="achei-tipo-mercosul">
                            <div class="placa-type-container">
                                <img src="mercosul.png" alt="Placa Mercosul" class="placa-type-image" id="achei-img-mercosul">
                                <span>Mercosul (ABC1D23)</span>
                            </div>
                        </label>
                    </div>
                </div>
            </div>
            
            <div class="form-group">
                <label for="achei-placa">Número da placa:</label>
                <input type="text" id="achei-placa" class="placa-input" placeholder="Digite a placa">
                <div class="placa-example" id="achei-placa-example">Exemplo: ABC-1234</div>
            </div>
            
            <div class="form-group">
                <label for="achei-nome">Seu nome:</label>
                <input type="text" id="achei-nome" placeholder="Digite seu nome completo">
            </div>
            
            <div class="form-group">
                <label for="achei-telefone">Seu telefone:</label>
                <input type="tel" id="achei-telefone" placeholder="(00) 00000-0000">
            </div>
            
            <div class="actions">
                <button id="achei-voltar" class="btn btn-secondary">Voltar</button>
                <button id="achei-salvar" class="btn btn-success">Salvar Placa</button>
            </div>
            
            <div id="achei-result" class="result">
                <p id="achei-result-text"></p>
            </div>
        </div>
    </div>
    
    <footer>
        <div class="container">
            <p>SOS PLACA &copy; 2024 — 1 ano ajudando a comunidade!</p>
        </div>
    </footer>

    <!-- Firebase SDK v9 (Modular) -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
        import { getDatabase, ref, set, get, remove, push } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyClzqFmEL9y_ugHnC7V4DnFiANX6RLDYzc",
            authDomain: "teste-c702e.firebaseapp.com",
            databaseURL: "https://teste-c702e-default-rtdb.firebaseio.com",
            projectId: "teste-c702e",
            storageBucket: "teste-c702e.firebasestorage.app",
            messagingSenderId: "478905955045",
            appId: "1:478905955045:web:bb9d0623db8a9166e85a0c"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        
        console.log("Firebase inicializado com sucesso!");

        // Elementos da tela inicial
        const homeScreen = document.getElementById('home-screen');
        const perdiBtn = document.getElementById('perdi-btn');
        const acheiBtn = document.getElementById('achei-btn');
        
        // Elementos da tela "Perdi"
        const perdiScreen = document.getElementById('perdi-screen');
        const perdiVoltarBtn = document.getElementById('perdi-voltar');
        const perdiBuscarBtn = document.getElementById('perdi-buscar');
        const perdiTipoComum = document.getElementById('perdi-tipo-comum');
        const perdiTipoMercosul = document.getElementById('perdi-tipo-mercosul');
        const perdiPlacaInput = document.getElementById('perdi-placa');
        const perdiPlacaExample = document.getElementById('perdi-placa-example');
        const perdiResult = document.getElementById('perdi-result');
        const perdiResultText = document.getElementById('perdi-result-text');
        const perdiResultContatos = document.getElementById('perdi-result-contatos');
        const perdiRemoverBtn = document.getElementById('perdi-remover-btn');
        
        // Elementos da tela "Achei"
        const acheiScreen = document.getElementById('achei-screen');
        const acheiVoltarBtn = document.getElementById('achei-voltar');
        const acheiSalvarBtn = document.getElementById('achei-salvar');
        const acheiTipoComum = document.getElementById('achei-tipo-comum');
        const acheiTipoMercosul = document.getElementById('achei-tipo-mercosul');
        const acheiPlacaInput = document.getElementById('achei-placa');
        const acheiPlacaExample = document.getElementById('achei-placa-example');
        const acheiNomeInput = document.getElementById('achei-nome');
        const acheiTelefoneInput = document.getElementById('achei-telefone');
        const acheiResult = document.getElementById('achei-result');
        const acheiResultText = document.getElementById('achei-result-text');
        
        // Variáveis globais
        let currentPlaca = '';
        
        // Navegação entre telas
        perdiBtn.addEventListener('click', () => {
            homeScreen.classList.remove('active');
            perdiScreen.classList.add('active');
            resetPerdiScreen();
        });
        
        acheiBtn.addEventListener('click', () => {
            homeScreen.classList.remove('active');
            acheiScreen.classList.add('active');
            resetAcheiScreen();
        });
        
        perdiVoltarBtn.addEventListener('click', () => {
            perdiScreen.classList.remove('active');
            homeScreen.classList.add('active');
        });
        
        acheiVoltarBtn.addEventListener('click', () => {
            acheiScreen.classList.remove('active');
            homeScreen.classList.add('active');
        });
        
        // Atualiza exemplos de placa conforme tipo selecionado
        perdiTipoComum.addEventListener('change', updatePlacaExample);
        perdiTipoMercosul.addEventListener('change', updatePlacaExample);
        acheiTipoComum.addEventListener('change', updatePlacaExample);
        acheiTipoMercosul.addEventListener('change', updatePlacaExample);
        
        function updatePlacaExample() {
            const isComum = document.querySelector('#perdi-screen.active') ? 
                perdiTipoComum.checked : acheiTipoComum.checked;
                
            if (document.querySelector('#perdi-screen.active')) {
                perdiPlacaExample.textContent = isComum ? 'Exemplo: ABC-1234' : 'Exemplo: ABC1D23';
            } else {
                acheiPlacaExample.textContent = isComum ? 'Exemplo: ABC-1234' : 'Exemplo: ABC1D23';
            }
            
            updatePlacaImages();
        }
        
        // Atualiza a opacidade das imagens conforme seleção
        function updatePlacaImages() {
            // Para a tela Perdi
            if (document.querySelector('#perdi-screen.active')) {
                const perdiComumSelected = perdiTipoComum.checked;
                document.getElementById('perdi-img-comum').style.opacity = perdiComumSelected ? '1' : '0.6';
                document.getElementById('perdi-img-mercosul').style.opacity = perdiComumSelected ? '0.6' : '1';
            }
            
            // Para a tela Achei
            if (document.querySelector('#achei-screen.active')) {
                const acheiComumSelected = acheiTipoComum.checked;
                document.getElementById('achei-img-comum').style.opacity = acheiComumSelected ? '1' : '0.6';
                document.getElementById('achei-img-mercosul').style.opacity = acheiComumSelected ? '0.6' : '1';
            }
        }
        
        // Máscara para telefone
        acheiTelefoneInput.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length > 11) value = value.substring(0, 11);
            
            if (value.length > 0) {
                value = '(' + value;
                if (value.length > 3) {
                    value = [value.slice(0, 3), ') ', value.slice(3)].join('');
                }
                if (value.length > 10) {
                    value = [value.slice(0, 10), '-', value.slice(10)].join('');
                }
            }
            
            e.target.value = value;
        });
        
        // Máscara para placa comum
        function applyMascaraPlacaComum(input) {
            let value = input.value.replace(/[^a-zA-Z0-9]/g, '').toUpperCase();
            if (value.length > 7) value = value.substring(0, 7);
            
            if (value.length > 3) {
                value = value.substring(0, 3) + '-' + value.substring(3);
            }
            
            input.value = value;
        }
        
        // Máscara para placa Mercosul
        function applyMascaraPlacaMercosul(input) {
            let value = input.value.replace(/[^a-zA-Z0-9]/g, '').toUpperCase();
            if (value.length > 7) value = value.substring(0, 7);
            
            input.value = value;
        }
        
        // Aplica máscara conforme tipo de placa
        perdiPlacaInput.addEventListener('input', function() {
            if (perdiTipoComum.checked) {
                applyMascaraPlacaComum(this);
            } else {
                applyMascaraPlacaMercosul(this);
            }
        });
        
        acheiPlacaInput.addEventListener('input', function() {
            if (acheiTipoComum.checked) {
                applyMascaraPlacaComum(this);
            } else {
                applyMascaraPlacaMercosul(this);
            }
        });
        
        // Validação de placa
        function validarPlaca(placa, tipo) {
            if (tipo === 'comum') {
                const regex = /^[A-Z]{3}-?\d{4}$/;
                return regex.test(placa);
            } else {
                const regex = /^[A-Z]{3}\d[A-Z]\d{2}$/;
                return regex.test(placa);
            }
        }
        
        // Formata placa para salvar no banco (sem traço)
        function formatarPlaca(placa) {
            return placa.replace('-', '');
        }
        
        // Buscar placa perdida
        perdiBuscarBtn.addEventListener('click', async function() {
            const tipo = perdiTipoComum.checked ? 'comum' : 'mercosul';
            const placa = perdiPlacaInput.value.trim();
            
            if (!validarPlaca(placa, tipo)) {
                showResult(perdiResult, 'error', 'Placa inválida. Verifique o formato conforme o tipo selecionado.');
                return;
            }
            
            const placaFormatada = formatarPlaca(placa);
            currentPlaca = placaFormatada;
            
            try {
                const dbRef = ref(database, 'placas/' + placaFormatada);
                const snapshot = await get(dbRef);
                
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    
                    // Limpa contatos anteriores
                    perdiResultContatos.innerHTML = '';
                    
                    // Verifica se é um objeto único ou múltiplos cadastros
                    if (data.nome) {
                        // Formato antigo (único cadastro)
                        showContato(data);
                    } else {
                        // Novo formato (múltiplos cadastros)
                        let contatosCount = 0;
                        for (const key in data) {
                            if (data.hasOwnProperty(key)) {
                                showContato(data[key]);
                                contatosCount++;
                            }
                        }
                        perdiResultText.textContent = `A placa ${placa} foi encontrada por ${contatosCount} pessoa(s)!`;
                    }
                    
                    showResult(perdiResult, 'success', `A placa ${placa} foi encontrada!`);
                    perdiRemoverBtn.style.display = 'inline-block';
                } else {
                    showResult(
                        perdiResult, 
                        'error', 
                        `A placa ${placa} não foi encontrada em nosso sistema. Tente novamente mais tarde!`,
                        'Se alguém encontrar e cadastrar, entraremos em contato.'
                    );
                    perdiRemoverBtn.style.display = 'none';
                }
            } catch (error) {
                console.error('Erro detalhado:', error);
                showResult(perdiResult, 'error', 'Ocorreu um erro ao buscar a placa. Tente novamente.');
            }
        });
        
        // Mostra um contato na lista de resultados
        function showContato(contato) {
            const contatoDiv = document.createElement('div');
            contatoDiv.className = 'contato-item';
            
            const infoDiv = document.createElement('div');
            infoDiv.className = 'contato-info';
            infoDiv.textContent = `Contato: ${contato.nome || 'Nome não informado'} - ${contato.telefone || 'Telefone não informado'}`;
            
            contatoDiv.appendChild(infoDiv);
            
            if (contato.telefone) {
                const whatsappBtn = document.createElement('button');
                whatsappBtn.className = 'btn btn-whatsapp';
                whatsappBtn.textContent = 'Contatar via WhatsApp';
                
                const mensagem = `Olá ${contato.nome || ''}, vi seu contato no SOS PLACA sobre a placa ${perdiPlacaInput.value.trim()} que encontrou.`;
                const whatsappLink = `https://wa.me/${contato.telefone.replace(/\D/g, '')}?text=${encodeURIComponent(mensagem)}`;
                whatsappBtn.onclick = () => window.open(whatsappLink, '_blank');
                
                contatoDiv.appendChild(whatsappBtn);
            }
            
            perdiResultContatos.appendChild(contatoDiv);
        }
        
        // Remover placa do sistema
        perdiRemoverBtn.addEventListener('click', async function() {
            if (!currentPlaca || !confirm('Tem certeza que deseja remover esta placa do sistema? Faça isso se já estiver em contato com quem a encontrou.')) {
                return;
            }
            
            try {
                await remove(ref(database, 'placas/' + currentPlaca));
                showResult(
                    perdiResult, 
                    'success', 
                    `A placa foi removida do sistema com sucesso.`,
                    'Obrigado por utilizar o SOS PLACA!'
                );
                perdiRemoverBtn.style.display = 'none';
                currentPlaca = '';
            } catch (error) {
                showResult(perdiResult, 'error', 'Ocorreu um erro ao remover a placa. Tente novamente.');
                console.error('Erro ao remover placa:', error);
            }
        });
        
        // Cadastrar placa encontrada
        acheiSalvarBtn.addEventListener('click', async function() {
            const tipo = acheiTipoComum.checked ? 'comum' : 'mercosul';
            const placa = acheiPlacaInput.value.trim();
            const nome = acheiNomeInput.value.trim();
            const telefone = acheiTelefoneInput.value.trim();
            
            // Validações
            if (!validarPlaca(placa, tipo)) {
                showResult(acheiResult, 'error', 'Placa inválida. Verifique o formato conforme o tipo selecionado.');
                return;
            }
            
            if (nome.length < 3) {
                showResult(acheiResult, 'error', 'O nome deve ter pelo menos 3 caracteres.');
                return;
            }
            
            const telefoneNumeros = telefone.replace(/\D/g, '');
            if (telefoneNumeros.length < 11) {
                showResult(acheiResult, 'error', 'Telefone inválido. Use o formato (00) 00000-0000.');
                return;
            }
            
            const placaFormatada = formatarPlaca(placa);
            const dados = {
                nome: nome,
                telefone: telefone,
                timestamp: Date.now()
            };
            
            try {
                const dbRef = ref(database, 'placas/' + placaFormatada);
                const snapshot = await get(dbRef);
                
                // Verifica se já existe cadastro para esta placa
                if (snapshot.exists()) {
                    const existingData = snapshot.val();
                    
                    // Se já for um objeto com múltiplos cadastros
                    if (!existingData.nome) {
                        // Conta quantos cadastros já existem
                        const contatosCount = Object.keys(existingData).length;
                        if (contatosCount >= 2) {
                            showResult(acheiResult, 'error', 'Esta placa já possui 2 cadastros. Não é possível adicionar mais.');
                            return;
                        }
                        
                        // Adiciona novo cadastro à lista existente
                        await push(ref(database, 'placas/' + placaFormatada), dados);
                    } else {
                        // Se for um único cadastro, transforma em lista com 2 itens
                        if (existingData.nome === nome && existingData.telefone === telefone) {
                            showResult(acheiResult, 'error', 'Você já cadastrou esta placa anteriormente.');
                            return;
                        }
                        
                        // Cria uma nova estrutura com os dois cadastros
                        const newData = {
                            cadastro1: existingData,
                            cadastro2: dados
                        };
                        
                        await set(ref(database, 'placas/' + placaFormatada), newData);
                    }
                } else {
                    // Primeiro cadastro para esta placa
                    await set(ref(database, 'placas/' + placaFormatada), dados);
                }
                
                showResult(
                    acheiResult, 
                    'success', 
                    `Placa ${placa} cadastrada com sucesso!`,
                    'Quando o dono da placa buscar, ele verá seus dados de contato.'
                );
                
                // Limpa os campos
                acheiPlacaInput.value = '';
                acheiNomeInput.value = '';
                acheiTelefoneInput.value = '';
            } catch (error) {
                showResult(acheiResult, 'error', 'Ocorreu um erro ao cadastrar a placa. Tente novamente.');
                console.error('Erro ao cadastrar placa:', error);
            }
        });
        
        // Mostra mensagem de resultado
        function showResult(element, type, text, additionalText = '') {
            element.className = 'result ' + type;
            const textElement = element.querySelector('p:first-of-type');
            if (textElement) {
                textElement.textContent = text;
            }
            
            if (additionalText && element.querySelector('p:nth-of-type(2)')) {
                element.querySelector('p:nth-of-type(2)').textContent = additionalText;
            }
        }
        
        // Reseta telas
        function resetPerdiScreen() {
            perdiPlacaInput.value = '';
            perdiResult.className = 'result';
            perdiResultContatos.innerHTML = '';
            perdiRemoverBtn.style.display = 'none';
            currentPlaca = '';
        }
        
        function resetAcheiScreen() {
            acheiPlacaInput.value = '';
            acheiNomeInput.value = '';
            acheiTelefoneInput.value = '';
            acheiResult.className = 'result';
        }
        
        // Inicializa exemplos de placa e imagens
        updatePlacaExample();
        updatePlacaImages();
    </script>
</body>
</html>
