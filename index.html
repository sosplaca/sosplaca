<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SOS PLACA</title>
  <link rel="icon" type="image/png" href="logo.png">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Roboto', sans-serif; }
    body { background-color: #f5f5f5; color: #333; line-height: 1.6; }
    .container { max-width: 900px; margin: 0 auto; padding: 20px; }
    header { background-color: #2c3e50; color: white; padding: 20px; text-align: center; border-radius: 0 0 10px 10px; }
    .logo { font-size: 2.5rem; font-weight: bold; }
    h1 { font-size: 1.5rem; }
    .screen { background-color: white; padding: 25px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; display: none; }
    .screen.active { display: block; }
    .btn { display: inline-block; background-color: #3498db; color: white; padding: 12px 24px; border: none; border-radius: 5px; cursor: pointer; font-size: 1rem; font-weight: 500; margin: 10px 5px; }
    .btn:hover { background-color: #2980b9; }
    .btn-success { background-color: #27ae60; }
    .btn-success:hover { background-color: #219653; }
    .btn-secondary { background-color: #95a5a6; }
    .btn-secondary:hover { background-color: #7f8c8d; }
    .btn-danger { background-color: #e74c3c; }
    .btn-danger:hover { background-color: #c0392b; }

    .tipo-btns {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }

    .tipo-btn {
      flex: 1;
      padding: 12px;
      text-align: center;
      border: 2px solid #ccc;
      border-radius: 5px;
      cursor: pointer;
      font-weight: 500;
      background-color: #fff;
    }

    .tipo-btn.ativo {
      background-color: #3498db;
      color: white;
      border-color: #2980b9;
    }

    .form-group { margin-bottom: 20px; }
    label { display: block; margin-bottom: 8px; font-weight: 500; }
    input, select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 1rem; }
    .result { margin-top: 20px; padding: 15px; border-radius: 5px; background-color: #f8f9fa; display: none; }
    .result.success { display: block; border-left: 4px solid #27ae60; }
    .result.error { display: block; border-left: 4px solid #e74c3c; }
    footer { text-align: center; padding: 20px; background-color: #ecf0f1; margin-top: 30px; }
    @media (max-width:600px) {
      .container { padding: 10px; }
      .screen { padding: 15px; }
      .btn { padding: 10px 15px; font-size: 0.9rem; }
      .tipo-btns { flex-direction: column; }
    }
  </style>
</head>
<body>
<header>
  <div class="container">
    <div class="logo">SOS PLACA</div>
    <h1>Ajude a reunir placas perdidas com seus donos</h1>
    <a href="https://play.google.com/store/apps/details?id=fabricioramosdasilva.sos_placa" target="_blank" class="btn btn-success">üì≤ Baixe o App</a>
  </div>
</header>
<div class="container">

  <!-- Tela inicial -->
  <div id="home-screen" class="screen active">
    <h2>O que voc√™ deseja fazer?</h2>
    <div>
      <button id="perdi-btn" class="btn">Perdi uma placa</button>
      <button id="achei-btn" class="btn btn-success">Achei uma placa</button>
    </div>
  </div>

  <!-- Tela Perdi -->
  <div id="perdi-screen" class="screen">
    <h2>Buscar placa perdida</h2>
    <div class="form-group">
      <label>Tipo de placa:</label>
      <div class="tipo-btns">
        <div id="btn-perdi-comum" class="tipo-btn ativo">Comum</div>
        <div id="btn-perdi-mercosul" class="tipo-btn">Mercosul</div>
      </div>
    </div>
    <div class="form-group">
      <label for="perdi-placa">N√∫mero da placa:</label>
      <input type="text" id="perdi-placa" class="placa-input" placeholder="Digite a placa">
    </div>
    <div class="form-group" id="perdi-localizacao" style="display:block;">
      <label for="perdi-uf">UF:</label>
      <select id="perdi-uf"></select>
      <label for="perdi-municipio">Munic√≠pio:</label>
      <select id="perdi-municipio"></select>
    </div>
    <div>
      <button id="perdi-voltar" class="btn btn-secondary">Voltar</button>
      <button id="perdi-buscar" class="btn">Buscar Placa</button>
    </div>
    <div id="perdi-result" class="result">
      <p id="perdi-result-text"></p>
      <div id="perdi-result-contatos"></div>
      <button id="perdi-remover-btn" class="btn btn-danger" style="display:none;">Remover placa</button>
    </div>
  </div>

  <!-- Tela Achei -->
  <div id="achei-screen" class="screen">
    <h2>Cadastrar placa encontrada</h2>
    <div class="form-group">
      <label>Tipo de placa:</label>
      <div class="tipo-btns">
        <div id="btn-achei-comum" class="tipo-btn ativo">Comum</div>
        <div id="btn-achei-mercosul" class="tipo-btn">Mercosul</div>
      </div>
    </div>
    <div class="form-group">
      <label for="achei-placa">N√∫mero da placa:</label>
      <input type="text" id="achei-placa" class="placa-input" placeholder="Digite a placa">
    </div>
    <div class="form-group" id="achei-localizacao" style="display:block;">
      <label for="achei-uf">UF:</label>
      <select id="achei-uf"></select>
      <label for="achei-municipio">Munic√≠pio:</label>
      <select id="achei-municipio"></select>
    </div>
    <div class="form-group">
      <label for="achei-nome">Seu nome:</label>
      <input type="text" id="achei-nome" placeholder="Digite seu nome completo">
    </div>
    <div class="form-group">
      <label for="achei-telefone">Seu telefone:</label>
      <input type="tel" id="achei-telefone" placeholder="(00) 00000-0000 ou (00) 0000-0000">
    </div>
    <div>
      <button id="achei-voltar" class="btn btn-secondary">Voltar</button>
      <button id="achei-salvar" class="btn btn-success">Salvar Placa</button>
      <button id="achei-salvar-outra" class="btn btn-success">Salvar e Cadastrar Outra Placa</button>
    </div>
    <div id="achei-result" class="result">
      <p id="achei-result-text"></p>
    </div>
  </div>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
  import { getDatabase, ref, set, get } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";
  import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

  document.addEventListener("DOMContentLoaded", () => {
    const firebaseConfig = {
      apiKey: "AIzaSyBjetihGmlo_z01jx-GW9Ith0oDCS0jwYc",
      authDomain: "sosplaca-73cf7.firebaseapp.com",
      databaseURL: "https://sosplaca-73cf7-default-rtdb.firebaseio.com",
      projectId: "sosplaca-73cf7",
      storageBucket: "sosplaca-73cf7.appspot.com",
      messagingSenderId: "658059385722",
      appId: "1:658059385722:web:5ed0e8fd7f7a2931d894c3"
    };

    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);
    const firestore = getFirestore(app);

    // Navega√ß√£o
    const homeScreen = document.getElementById('home-screen');
    const perdiScreen = document.getElementById('perdi-screen');
    const acheiScreen = document.getElementById('achei-screen');
    const avisoScreen = document.getElementById('aviso-screen');

    const switchScreen = (from, to) => {
      from.classList.remove('active');
      to.classList.add('active');
    };

    document.getElementById('perdi-btn').onclick = () => switchScreen(homeScreen, perdiScreen);
    document.getElementById('achei-btn').onclick = () => switchScreen(homeScreen, acheiScreen);
    document.getElementById('perdi-voltar').onclick = () => switchScreen(perdiScreen, homeScreen);
    document.getElementById('achei-voltar').onclick = () => switchScreen(acheiScreen, homeScreen);
    document.getElementById('aviso-voltar').onclick = () => switchScreen(avisoScreen, homeScreen);

    // Altern√¢ncia de tipo
    let tipoPerdi = 'comum';
    let tipoAchei = 'comum';

    const alternarTipo = (grupo, tipo) => {
      document.getElementById(`btn-${grupo}-comum`).classList.remove('ativo');
      document.getElementById(`btn-${grupo}-mercosul`).classList.remove('ativo');
      document.getElementById(`btn-${grupo}-${tipo}`).classList.add('ativo');

      if (grupo === 'perdi') {
        tipoPerdi = tipo;
        document.getElementById('perdi-localizacao').style.display = tipo === 'comum' ? 'block' : 'none';
      } else {
        tipoAchei = tipo;
        document.getElementById('achei-localizacao').style.display = tipo === 'comum' ? 'block' : 'none';
      }
    };

    document.getElementById('btn-perdi-comum').onclick = () => alternarTipo('perdi', 'comum');
    document.getElementById('btn-perdi-mercosul').onclick = () => alternarTipo('perdi', 'mercosul');
    document.getElementById('btn-achei-comum').onclick = () => alternarTipo('achei', 'comum');
    document.getElementById('btn-achei-mercosul').onclick = () => alternarTipo('achei', 'mercosul');

    // M√°scara de placa
    function aplicarMascaraPlaca(input, tipo) {
      let value = input.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
      if (tipo === 'comum') {
        value = value.slice(0, 7);
        if (value.length > 3) value = value.slice(0, 3) + '-' + value.slice(3);
      } else {
        value = value.slice(0, 7);
      }
      input.value = value;
    }

    // M√°scara de telefone
    function aplicarMascaraTelefone(input) {
      let value = input.value.replace(/\D/g, '').slice(0, 11);
      if (value.length <= 10) {
        value = value.replace(/(\d{2})(\d{4})(\d{0,4})/, '($1) $2-$3');
      } else {
        value = value.replace(/(\d{2})(\d{5})(\d{0,4})/, '($1) $2-$3');
      }
      input.value = value;
    }

    document.getElementById('achei-placa').addEventListener('input', e => aplicarMascaraPlaca(e.target, tipoAchei));
    document.getElementById('perdi-placa').addEventListener('input', e => aplicarMascaraPlaca(e.target, tipoPerdi));
    document.getElementById('achei-telefone').addEventListener('input', e => aplicarMascaraTelefone(e.target));

    function gerarCaminho(tipo, placa, uf, municipio) {
      return tipo === 'comum' ? `${placa}:${uf}:${municipio}` : `${placa}:null:null:true`;
    }

    function formatarPlaca(placa) {
      return placa.replace('-', '').toUpperCase();
    }

    function validarPlaca(placa, tipo) {
      if (tipo === 'comum') return /^[A-Z]{3}-\d{4}$/.test(placa);
      else return /^[A-Z]{3}\d[A-Z]\d{2}$/.test(placa);
    }

    function validarTelefone(tel) {
      const digitos = tel.replace(/\D/g, '');
      return digitos.length >= 10 && digitos.length <= 11;
    }

    function validarLocalizacao(tipo, uf, municipio) {
      return tipo === 'comum' ? (uf && municipio) : true;
    }

    // Buscar placa
    document.getElementById('perdi-buscar').onclick = async () => {
      const tipo = tipoPerdi;
      const placaBruta = document.getElementById('perdi-placa').value.trim();
      const placa = formatarPlaca(placaBruta);
      const uf = document.getElementById('perdi-uf').value;
      const municipio = document.getElementById('perdi-municipio').value;

      if (!validarPlaca(placaBruta, tipo)) {
        alert('Placa inv√°lida!');
        return;
      }
      if (!validarLocalizacao(tipo, uf, municipio)) {
        alert('UF e Munic√≠pio obrigat√≥rios para placa comum.');
        return;
      }

      const path = gerarCaminho(tipo, placa, uf, municipio);
      const snapshot = await get(ref(database, path));

      if (snapshot.exists()) {
        const dados = snapshot.val();
        alert(`Placa encontrada!\n\nContato: ${dados.nome} - ${dados.telefone}`);
      } else {
        if (confirm('Placa n√£o encontrada. Deseja ser avisado quando ela for cadastrada?')) {
          document.getElementById('aviso-placa').value = placa;
          switchScreen(perdiScreen, avisoScreen);
        }
      }
    };

    // Salvar placa
    async function salvarPlaca(outra = false) {
      const tipo = tipoAchei;
      const placaBruta = document.getElementById('achei-placa').value.trim();
      const placa = formatarPlaca(placaBruta);
      const nome = document.getElementById('achei-nome').value.trim();
      const telefone = document.getElementById('achei-telefone').value.trim();
      const uf = document.getElementById('achei-uf').value;
      const municipio = document.getElementById('achei-municipio').value;

      if (!validarPlaca(placaBruta, tipo)) return alert('Placa inv√°lida!');
      if (!nome || nome.length < 3) return alert('Digite seu nome.');
      if (!validarTelefone(telefone)) return alert('Telefone inv√°lido.');
      if (!validarLocalizacao(tipo, uf, municipio)) return alert('UF e Munic√≠pio obrigat√≥rios para placa comum.');

      const path = gerarCaminho(tipo, placa, uf, municipio);
      const dadosRealtime = { nome, telefone };

      // 1. Salva no Realtime Database
      await set(ref(database, path), dadosRealtime);

      // 2. Salva no Firestore (cole√ß√£o foundPlates)
      const dadosFirestore = {
        founderName: nome,
        founderPhone: telefone,
        foundDate: new Date(),
        location: {
          city: tipo === 'comum' ? municipio : '',
          uf: tipo === 'comum' ? uf : '',
          plate: placa
        }
      };
      await addDoc(collection(firestore, "foundPlates"), dadosFirestore);

      alert(`‚úÖ Placa ${placaBruta} cadastrada com sucesso!`);

      if (outra) {
        document.getElementById('achei-placa').value = '';
        document.getElementById('achei-uf').value = '';
        document.getElementById('achei-municipio').value = '';
      } else {
        switchScreen(acheiScreen, homeScreen);
      }
    }

    document.getElementById('achei-salvar').onclick = () => salvarPlaca(false);
    document.getElementById('achei-salvar-outra').onclick = () => salvarPlaca(true);
  });
</script>
</body>
</html>
