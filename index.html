<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Ajude a reunir placas de ve√≠culos perdidas com seus donos">
  <meta name="theme-color" content="#2c3e50">
  <title>SOS PLACA</title>
  <link rel="icon" type="image/png" href="logo.png" sizes="32x32">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preload" href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <noscript><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap"></noscript>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Roboto', sans-serif; }
    body { background-color: #f5f5f5; color: #333; line-height: 1.6; }
    .container { max-width: 900px; margin: 0 auto; padding: 20px; }
    header { background-color: #2c3e50; color: #fff; padding: 1.25rem; text-align: center; border-radius: 0 0 0.625rem 0.625rem; }
    .logo { font-size: 2.5rem; font-weight: bold; }
    h1 { font-size: 1.5rem; }
    .screen { background-color: #fff; padding: 1.5rem; border-radius: 0.625rem; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 1.25rem; display: none; }
    .screen.active { display: block; }
    .btn { display: inline-block; background-color: #3498db; color: #fff; padding: 0.75rem 1.5rem; border: none; border-radius: 0.3125rem; cursor: pointer; font-size: 1rem; font-weight: 500; margin: 0.625rem 0.3125rem; transition: background-color 0.3s; }
    .btn:hover { background-color: #2980b9; }
    .btn-success { background-color: #27ae60; }
    .btn-success:hover { background-color: #219653; }
    .btn-secondary { background-color: #95a5a6; }
    .btn-secondary:hover { background-color: #7f8c8d; }
    .btn-danger { background-color: #e74c3c; }
    .btn-danger:hover { background-color: #c0392b; }
    .tipo-btns { display: flex; gap: 0.625rem; margin-bottom: 0.9375rem; }
    .tipo-btn { flex: 1; padding: 0.75rem; text-align: center; border: 2px solid #ccc; border-radius: 0.3125rem; cursor: pointer; font-weight: 500; background-color: #fff; transition: all 0.3s; }
    .tipo-btn.ativo { background-color: #3498db; color: #fff; border-color: #2980b9; }
    .form-group { margin-bottom: 1.25rem; }
    label { display: block; margin-bottom: 0.5rem; font-weight: 500; }
    input, select { width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 0.3125rem; font-size: 1rem; transition: border-color 0.3s; }
    input:invalid { border-color: #e74c3c; }
    .result { margin-top: 1.25rem; padding: 0.9375rem; border-radius: 0.3125rem; background-color: #f8f9fa; display: none; }
    .result.success { display: block; border-left: 4px solid #27ae60; }
    .result.error { display: block; border-left: 4px solid #e74c3c; }
    footer { text-align: center; padding: 1.25rem; background-color: #ecf0f1; margin-top: 1.875rem; }
    .spinner { display: inline-block; width: 1rem; height: 1rem; border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: #fff; animation: spin 1s ease-in-out infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); white-space: nowrap; border: 0; }
    @media (max-width:600px) {
      .container { padding: 0.625rem; }
      .screen { padding: 0.9375rem; }
      .btn { padding: 0.625rem 0.9375rem; font-size: 0.9rem; }
      .tipo-btns { flex-direction: column; }
    }
  </style>
</head>
<body>
<header role="banner">
  <div class="container">
    <div class="logo" aria-label="SOS Placa">SOS PLACA</div>
    <h1>Ajude a reunir placas perdidas com seus donos</h1>
    <a href="https://play.google.com/store/apps/details?id=fabricioramosdasilva.sos_placa" 
       target="_blank" 
       rel="noopener noreferrer"
       class="btn btn-success"
       aria-label="Baixe nosso aplicativo na Play Store">üì≤ Baixe o App</a>
  </div>
</header>
<div class="container">
  <!-- Feedback messages -->
  <div id="error-message" class="result error" style="display:none;"></div>
  <div id="success-message" class="result success" style="display:none;"></div>

  <!-- Tela inicial -->
  <div id="home-screen" class="screen active" role="region" aria-labelledby="home-title">
    <h2 id="home-title">O que voc√™ deseja fazer?</h2>
    <div class="form-actions">
      <button id="perdi-btn" class="btn" aria-label="Reportar placa perdida">Perdi uma placa</button>
      <button id="achei-btn" class="btn btn-success" aria-label="Cadastrar placa encontrada">Achei uma placa</button>
    </div>
  </div>

  <!-- Tela Perdi -->
  <div id="perdi-screen" class="screen" role="region" aria-labelledby="perdi-title">
    <h2 id="perdi-title">Buscar placa perdida</h2>
    <div class="form-group">
      <label id="perdi-tipo-label">Tipo de placa:</label>
      <div class="tipo-btns" role="group" aria-labelledby="perdi-tipo-label">
        <button type="button" id="btn-perdi-comum" class="tipo-btn ativo" aria-pressed="true">Comum</button>
        <button type="button" id="btn-perdi-mercosul" class="tipo-btn" aria-pressed="false">Mercosul</button>
      </div>
    </div>
    <div class="form-group">
      <label for="perdi-placa">N√∫mero da placa:</label>
      <input type="text" id="perdi-placa" class="placa-input" 
             placeholder="AAA-0000 ou AAA0A00"
             aria-describedby="perdi-placa-help"
             required
             pattern="[A-Z]{3}-?\d[0-9A-Z]\d{2}">
      <small id="perdi-placa-help" class="sr-only">Formato: AAA-0000 para comum ou AAA0A00 para Mercosul</small>
    </div>
    <div class="form-group" id="perdi-localizacao">
      <label for="perdi-uf">UF:</label>
      <select id="perdi-uf" required aria-required="true">
        <option value="" disabled selected>Selecione seu estado</option>
      </select>
      <label for="perdi-municipio">Munic√≠pio:</label>
      <select id="perdi-municipio" required aria-required="true">
        <option value="" disabled selected>Selecione seu munic√≠pio</option>
      </select>
    </div>
    <div class="form-actions">
      <button id="perdi-voltar" class="btn btn-secondary">Voltar</button>
      <button id="perdi-buscar" class="btn">Buscar Placa</button>
    </div>
    <div id="perdi-result" class="result" aria-live="polite">
      <p id="perdi-result-text"></p>
      <div id="perdi-result-contatos"></div>
      <button id="perdi-remover-btn" class="btn btn-danger" style="display:none;">Remover placa</button>
    </div>
  </div>

  <!-- Tela Achei -->
  <div id="achei-screen" class="screen" role="region" aria-labelledby="achei-title">
    <h2 id="achei-title">Cadastrar placa encontrada</h2>
    <div class="form-group">
      <label id="achei-tipo-label">Tipo de placa:</label>
      <div class="tipo-btns" role="group" aria-labelledby="achei-tipo-label">
        <button type="button" id="btn-achei-comum" class="tipo-btn ativo" aria-pressed="true">Comum</button>
        <button type="button" id="btn-achei-mercosul" class="tipo-btn" aria-pressed="false">Mercosul</button>
      </div>
    </div>
    <div class="form-group">
      <label for="achei-placa">N√∫mero da placa:</label>
      <input type="text" id="achei-placa" class="placa-input" 
             placeholder="AAA-0000 ou AAA0A00"
             aria-describedby="achei-placa-help"
             required
             pattern="[A-Z]{3}-?\d[0-9A-Z]\d{2}">
      <small id="achei-placa-help" class="sr-only">Formato: AAA-0000 para comum ou AAA0A00 para Mercosul</small>
    </div>
    <div class="form-group" id="achei-localizacao">
      <label for="achei-uf">UF:</label>
      <select id="achei-uf" required aria-required="true">
        <option value="" disabled selected>Selecione o estado</option>
      </select>
      <label for="achei-municipio">Munic√≠pio:</label>
      <select id="achei-municipio" required aria-required="true">
        <option value="" disabled selected>Selecione o munic√≠pio</option>
      </select>
    </div>
    <div class="form-group">
      <label for="achei-nome">Seu nome:</label>
      <input type="text" id="achei-nome" 
             placeholder="Digite seu nome completo"
             required
             minlength="3">
    </div>
    <div class="form-group">
      <label for="achei-telefone">Seu telefone:</label>
      <input type="tel" id="achei-telefone" 
             placeholder="(00) 00000-0000 ou (00) 0000-0000"
             aria-describedby="telefone-help"
             required
             pattern="(\(\d{2}\)\s?)?\d{4,5}[-\s]?\d{4}">
      <small id="telefone-help" class="sr-only">Formato: (00) 00000-0000 ou (00) 0000-0000</small>
    </div>
    <div class="form-actions">
      <button id="achei-voltar" class="btn btn-secondary">Voltar</button>
      <button id="achei-salvar" class="btn btn-success">Salvar Placa</button>
      <button id="achei-salvar-outra" class="btn btn-success">Salvar e Cadastrar Outra</button>
    </div>
    <div id="achei-result" class="result" aria-live="polite">
      <p id="achei-result-text"></p>
    </div>
  </div>
</div>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
  import { getDatabase, ref, set, get, onValue } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";
  import { getFirestore, collection, addDoc, serverTimestamp, query, where, getDocs } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBjetihGmlo_z01jx-GW9Ith0oDCS0jwYc",
    authDomain: "sosplaca-73cf7.firebaseapp.com",
    databaseURL: "https://sosplaca-73cf7-default-rtdb.firebaseio.com",
    projectId: "sosplaca-73cf7",
    storageBucket: "sosplaca-73cf7.appspot.com",
    messagingSenderId: "658059385722",
    appId: "1:658059385722:web:5ed0e8fd7f7a2931d894c3"
  };

  const app = initializeApp(firebaseConfig);
  const database = getDatabase(app);
  const firestore = getFirestore(app);

  // ... (c√≥digo anterior de elementos DOM e estados)

  async function buscarPlaca() {
    try {
      toggleLoading(true, elementos.buttons.perdiBuscar);
      
      const { tipoPerdi: tipo } = state;
      const placaBruta = elementos.inputs.placas.perdi.value.trim();
      const placa = formatarPlaca(placaBruta);
      const uf = elementos.inputs.uf.perdi.value;
      const municipio = elementos.inputs.municipio.perdi.value;

      if (!validarPlaca(placaBruta, tipo)) {
        showError('Placa inv√°lida! Verifique o formato.');
        return;
      }

      if (tipo === 'comum' && (!uf || !municipio)) {
        showError('UF e Munic√≠pio s√£o obrigat√≥rios para placa comum.');
        return;
      }

      // 1. Busca no Firestore (formato do app)
      const q = query(collection(firestore, "foundPlates"), 
                where("plate", "==", tipo === 'comum' ? placaBruta : placa));
      
      const querySnapshot = await getDocs(q);
      
      if (!querySnapshot.empty) {
        querySnapshot.forEach((doc) => {
          const dados = doc.data();
          const telefoneFormatado = formatarTelefoneExibicao(dados.founderPhone);
          elementos.results.perdi.textContent = `Placa encontrada! Contato: ${dados.founderName} - ${telefoneFormatado}`;
          elementos.results.perdi.parentElement.style.display = 'block';
        });
        return;
      }

      // 2. Busca alternativa no Firestore (formato do site)
      const qAlternativo = query(collection(firestore, "foundPlates"), 
                where("plate", "==", placa));
      
      const querySnapshotAlternativo = await getDocs(qAlternativo);
      
      if (!querySnapshotAlternativo.empty) {
        querySnapshotAlternativo.forEach((doc) => {
          const dados = doc.data();
          const telefoneFormatado = formatarTelefoneExibicao(dados.founderPhone);
          elementos.results.perdi.textContent = `Placa encontrada! Contato: ${dados.founderName} - ${telefoneFormatado}`;
          elementos.results.perdi.parentElement.style.display = 'block';
        });
        return;
      }

      // 3. Busca no Realtime Database (para compatibilidade)
      const path = `placas/${tipo === 'comum' ? placaBruta : placa}:${uf || 'null'}:${municipio || 'null'}${tipo === 'mercosul' ? ':true' : ''}`;

      const snapshot = await get(ref(database, path));

      if (snapshot.exists()) {
        const dados = snapshot.val();
        const telefoneFormatado = formatarTelefoneExibicao(dados.telefone);
        elementos.results.perdi.textContent = `Placa encontrada! Contato: ${dados.nome} - ${telefoneFormatado}`;
        elementos.results.perdi.parentElement.style.display = 'block';
      } else {
        elementos.results.perdi.textContent = 'Placa n√£o encontrada em nosso sistema.';
        elementos.results.perdi.parentElement.style.display = 'block';
      }
    } catch (error) {
      console.error('Erro ao buscar placa:', error);
      showError('Erro ao buscar placa. Tente novamente.');
    } finally {
      toggleLoading(false, elementos.buttons.perdiBuscar);
    }
  }

  async function salvarPlaca(outra = false) {
    try {
      toggleLoading(true, outra ? elementos.buttons.acheiSalvarOutra : elementos.buttons.acheiSalvar);
      
      const { tipoAchei: tipo } = state;
      const placaBruta = elementos.inputs.placas.achei.value.trim();
      const placa = formatarPlaca(placaBruta);
      const nome = elementos.inputs.acheiNome.value.trim();
      let telefone = elementos.inputs.acheiTelefone.value.trim();
      const uf = elementos.inputs.uf.achei.value;
      const municipio = elementos.inputs.municipio.achei.value;

      // Valida√ß√µes
      if (!validarPlaca(placaBruta, tipo)) {
        showError('Placa inv√°lida! Verifique o formato.');
        return;
      }

      if (!nome || nome.length < 3) {
        showError('Digite seu nome completo (m√≠nimo 3 caracteres).');
        return;
      }

      telefone = telefone.replace(/\D/g, ''); // Remove formata√ß√£o para salvar

      if (!validarTelefone(telefone)) {
        showError('Telefone inv√°lido. Use (00) 00000-0000 ou (00) 0000-0000');
        return;
      }

      if (tipo === 'comum' && (!uf || !municipio)) {
        showError('UF e Munic√≠pio s√£o obrigat√≥rios para placa comum.');
        return;
      }

      // 1. Salva no Firestore (formato compat√≠vel com app)
      const docData = {
        plate: tipo === 'comum' ? placaBruta : placa, // Mant√©m o h√≠fen para comum
        founderName: nome,
        founderPhone: telefone, // Apenas n√∫meros
        location: {
          city: tipo === 'comum' ? municipio : "",
          uf: tipo === 'comum' ? uf : ""
        },
        foundDate: serverTimestamp()
      };

      // Adiciona isMercosul apenas se for verdadeiro (como no site)
      if (tipo === 'mercosul') {
        docData.isMercosul = true;
      }

      const docRef = await addDoc(collection(firestore, "foundPlates"), docData);

      // 2. Salva no Realtime Database (formato compat√≠vel com app)
      const path = `placas/${tipo === 'comum' ? placaBruta : placa}:${uf || 'null'}:${municipio || 'null'}${tipo === 'mercosul' ? ':true' : ''}`;
      
      await set(ref(database, path), {
        nome: nome,
        telefone: telefone,
        tipo: tipo,
        uf: tipo === 'comum' ? uf : null,
        municipio: tipo === 'comum' ? municipio : null,
        mercosul: tipo === 'mercosul',
        timestamp: Date.now(),
        firestoreId: docRef.id
      });

      // Feedback
      elementos.results.achei.textContent = "Obrigado! Agora, assim que o dono procurar pela placa, ele poder√° entrar em contato pelo n√∫mero informado!";
      elementos.results.achei.parentElement.style.display = 'block';
      
      // Reset ou navega√ß√£o
      if (outra) {
        elementos.inputs.placas.achei.value = '';
        elementos.inputs.placas.achei.focus();
      } else {
        switchScreen(elementos.screens.achei, elementos.screens.home);
      }
    } catch (error) {
      console.error('Erro ao salvar placa:', error);
      showError('Erro ao cadastrar placa. Tente novamente.');
    } finally {
      toggleLoading(false, outra ? elementos.buttons.acheiSalvarOutra : elementos.buttons.acheiSalvar);
    }
  }

  // Fun√ß√£o auxiliar para formatar telefone para exibi√ß√£o
  function formatarTelefoneExibicao(telefone) {
    const nums = telefone.toString().replace(/\D/g, '');
    if (nums.length === 10) {
      return `(${nums.substring(0, 2)}) ${nums.substring(2, 6)}-${nums.substring(6, 10)}`;
    } else if (nums.length === 11) {
      return `(${nums.substring(0, 2)}) ${nums.substring(2, 7)}-${nums.substring(7, 11)}`;
    }
    return telefone; // Retorna original se n√£o puder formatar
  }

  // ... (restante das fun√ß√µes permanece igual)
</script>
</body>
</html>
