<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SOS PLACA</title>
  <link rel="icon" type="image/png" href="logo.png">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Roboto', sans-serif; }
    body { background-color: #f5f5f5; color: #333; line-height: 1.6; }
    .container { max-width: 900px; margin: 0 auto; padding: 20px; }
    header { background-color: #2c3e50; color: white; padding: 20px; text-align: center; border-radius: 0 0 10px 10px; }
    .logo { font-size: 2.5rem; font-weight: bold; }
    h1 { font-size: 1.5rem; }
    .screen { background-color: white; padding: 25px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; display: none; }
    .screen.active { display: block; }
    .btn { display: inline-block; background-color: #3498db; color: white; padding: 12px 24px; border: none; border-radius: 5px; cursor: pointer; font-size: 1rem; font-weight: 500; margin: 10px 5px; }
    .btn:hover { background-color: #2980b9; }
    .btn-success { background-color: #27ae60; }
    .btn-success:hover { background-color: #219653; }
    .btn-secondary { background-color: #95a5a6; }
    .btn-secondary:hover { background-color: #7f8c8d; }
    .btn-danger { background-color: #e74c3c; }
    .btn-danger:hover { background-color: #c0392b; }
    .form-group { margin-bottom: 20px; }
    label { display: block; margin-bottom: 8px; font-weight: 500; }
    input, select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 1rem; }
    .placa-type-container { display: flex; align-items: center; gap: 10px; }
    .placa-type-image { width: 80px; }
    .result { margin-top: 20px; padding: 15px; border-radius: 5px; background-color: #f8f9fa; display: none; }
    .result.success { display: block; border-left: 4px solid #27ae60; }
    .result.error { display: block; border-left: 4px solid #e74c3c; }
    footer { text-align: center; padding: 20px; background-color: #ecf0f1; margin-top: 30px; }
    .placa-card { border: 1px solid #ddd; padding: 15px; border-radius: 5px; margin-bottom: 15px; background-color: #fdfdfd; }
    .remove-placa { color: red; cursor: pointer; font-weight: bold; }
    @media (max-width:600px) {
      .container { padding: 10px; }
      .screen { padding: 15px; }
      .btn { padding: 10px 15px; font-size: 0.9rem; }
    }
  </style>
</head>
<body>
<header>
  <div class="container">
    <div class="logo">SOS PLACA</div>
    <h1>Ajude a reunir placas perdidas com seus donos</h1>
    <a href="https://play.google.com/store/apps/details?id=fabricioramosdasilva.sos_placa" target="_blank" class="btn btn-success">üì≤ Baixe o App</a>
  </div>
</header>

<div class="container">

  <!-- Tela inicial -->
  <div id="home-screen" class="screen active">
    <h2>O que voc√™ deseja fazer?</h2>
    <p>Escolha uma op√ß√£o:</p>
    <div>
      <button id="perdi-btn" class="btn">Perdi uma placa</button>
      <button id="achei-btn" class="btn btn-success">Achei uma placa</button>
      <button id="multi-achei-btn" class="btn btn-success">Achei v√°rias placas</button>
    </div>
  </div>
  <!-- Tela Perdi -->
  <div id="perdi-screen" class="screen">
    <h2>Buscar placa perdida</h2>
    <div class="form-group">
      <label>Tipo de placa:</label>
      <div class="placa-type-container">
        <input type="radio" id="perdi-tipo-comum" name="perdi-tipo-placa" value="comum" checked>
        <label for="perdi-tipo-comum"><img src="comum.png" class="placa-type-image">Padr√£o antigo (ABC-1234)</label>
      </div>
      <div class="placa-type-container">
        <input type="radio" id="perdi-tipo-mercosul" name="perdi-tipo-placa" value="mercosul">
        <label for="perdi-tipo-mercosul"><img src="mercosul.png" class="placa-type-image">Mercosul (ABC1D23)</label>
      </div>
    </div>
    <div class="form-group">
      <label for="perdi-placa">N√∫mero da placa:</label>
      <input type="text" id="perdi-placa" class="placa-input" placeholder="Digite a placa">
    </div>
    <div class="form-group" id="perdi-localizacao" style="display:none;">
      <label for="perdi-uf">UF:</label>
      <select id="perdi-uf"></select>
      <label for="perdi-municipio">Munic√≠pio:</label>
      <select id="perdi-municipio"></select>
    </div>
    <div>
      <button id="perdi-voltar" class="btn btn-secondary">Voltar</button>
      <button id="perdi-buscar" class="btn">Buscar Placa</button>
    </div>
    <div id="perdi-result" class="result">
      <p id="perdi-result-text"></p>
      <div id="perdi-result-contatos"></div>
      <button id="perdi-remover-btn" class="btn btn-danger" style="display:none;">Remover placa</button>
    </div>
  </div>

  <!-- Tela Achei -->
  <div id="achei-screen" class="screen">
    <h2>Cadastrar placa encontrada</h2>
    <div class="form-group">
      <label>Tipo de placa:</label>
      <div class="placa-type-container">
        <input type="radio" id="achei-tipo-comum" name="achei-tipo-placa" value="comum" checked>
        <label for="achei-tipo-comum"><img src="comum.png" class="placa-type-image">Padr√£o antigo (ABC-1234)</label>
      </div>
      <div class="placa-type-container">
        <input type="radio" id="achei-tipo-mercosul" name="achei-tipo-placa" value="mercosul">
        <label for="achei-tipo-mercosul"><img src="mercosul.png" class="placa-type-image">Mercosul (ABC1D23)</label>
      </div>
    </div>
    <div class="form-group">
      <label for="achei-placa">N√∫mero da placa:</label>
      <input type="text" id="achei-placa" class="placa-input" placeholder="Digite a placa">
    </div>
    <div class="form-group" id="achei-localizacao" style="display:none;">
      <label for="achei-uf">UF:</label>
      <select id="achei-uf"></select>
      <label for="achei-municipio">Munic√≠pio:</label>
      <select id="achei-municipio"></select>
    </div>
    <div class="form-group">
      <label for="achei-nome">Seu nome:</label>
      <input type="text" id="achei-nome" placeholder="Digite seu nome completo">
    </div>
    <div class="form-group">
      <label for="achei-telefone">Seu telefone:</label>
      <input type="tel" id="achei-telefone" placeholder="(00) 00000-0000 ou (00) 0000-0000">
    </div>
    <div>
      <button id="achei-voltar" class="btn btn-secondary">Voltar</button>
      <button id="achei-salvar" class="btn btn-success">Salvar Placa</button>
    </div>
    <div id="achei-result" class="result">
      <p id="achei-result-text"></p>
    </div>
  </div>

  <!-- Tela Achei V√°rias Placas -->
  <div id="multi-achei-screen" class="screen">
    <h2>Cadastrar v√°rias placas encontradas</h2>
    <div class="form-group">
      <label for="multi-achei-nome">Seu nome:</label>
      <input type="text" id="multi-achei-nome" placeholder="Digite seu nome completo">
    </div>
    <div class="form-group">
      <label for="multi-achei-telefone">Seu telefone:</label>
      <input type="tel" id="multi-achei-telefone" placeholder="(00) 00000-0000 ou (00) 0000-0000">
    </div>
    <div id="placas-container"></div>
    <div>
      <button id="add-placa-btn" class="btn">+ Adicionar Placa</button>
    </div>
    <div>
      <button id="multi-achei-voltar" class="btn btn-secondary">Voltar</button>
      <button id="multi-achei-salvar" class="btn btn-success">Salvar Todas</button>
    </div>
    <div id="multi-achei-result" class="result">
      <p id="multi-achei-result-text"></p>
    </div>
  </div>
  <!-- Tela Cadastro para ser avisado -->
  <div id="aviso-screen" class="screen">
    <h2>Quer ser avisado?</h2>
    <p>N√£o encontramos sua placa no momento. Preencha seus dados para ser avisado por e-mail caso algu√©m a cadastre como encontrada.</p>
    <div class="form-group">
      <label for="aviso-nome">Seu nome:</label>
      <input type="text" id="aviso-nome" placeholder="Digite seu nome completo">
    </div>
    <div class="form-group">
      <label for="aviso-email">Seu e-mail:</label>
      <input type="email" id="aviso-email" placeholder="email@exemplo.com">
    </div>
    <div class="form-group">
      <label for="aviso-placa">Placa:</label>
      <input type="text" id="aviso-placa" readonly>
    </div>
    <div>
      <button id="aviso-voltar" class="btn btn-secondary">Voltar</button>
      <button id="aviso-salvar" class="btn btn-success">Quero ser avisado</button>
    </div>
    <div id="aviso-result" class="result">
      <p id="aviso-result-text"></p>
    </div>
  </div>

  <footer>
    <div class="container">
      <p>SOS PLACA &copy; 2025 - Todos os direitos reservados.</p>
    </div>
  </footer>

<!-- ======================= SCRIPT ======================= -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
  import { getDatabase, ref, set, get, remove } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";
  import { getFirestore, doc, getDoc, setDoc, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBjetihGmlo_z01jx-GW9Ith0oDCS0jwYc",
    authDomain: "sosplaca-73cf7.firebaseapp.com",
    databaseURL: "https://sosplaca-73cf7-default-rtdb.firebaseio.com",
    projectId: "sosplaca-73cf7",
    storageBucket: "sosplaca-73cf7.appspot.com",
    messagingSenderId: "658059385722",
    appId: "1:658059385722:web:5ed0e8fd7f7a2931d894c3"
  };

  const app = initializeApp(firebaseConfig);
  const database = getDatabase(app);
  const firestore = getFirestore(app);

  console.log('Firebase conectado com sucesso ‚úÖ');

  // ==================== Estados e Cidades ====================
  const estadosECidades = {
    "SP": ["S√£o Paulo", "Campinas", "Santos", "Ubatuba"],
    "RJ": ["Rio de Janeiro", "Niter√≥i", "Petr√≥polis"],
    "MG": ["Belo Horizonte", "Uberl√¢ndia", "Juiz de Fora"],
    "BA": ["Salvador", "Feira de Santana", "Ilh√©us"],
    "PR": ["Curitiba", "Londrina", "Maring√°"],
    "RS": ["Porto Alegre", "Caxias do Sul", "Pelotas"],
    "SC": ["Florian√≥polis", "Joinville", "Blumenau"]
  };

  const ufElements = [
    { uf: document.getElementById('perdi-uf'), municipio: document.getElementById('perdi-municipio') },
    { uf: document.getElementById('achei-uf'), municipio: document.getElementById('achei-municipio') }
  ];

  function preencherEstados(ufEl, municipioEl) {
    ufEl.innerHTML = `<option value=''>Selecione o Estado</option>`;
    for (const estado in estadosECidades) {
      ufEl.innerHTML += `<option value='${estado}'>${estado}</option>`;
    }
    ufEl.addEventListener('change', () => {
      municipioEl.innerHTML = `<option value=''>Selecione o Munic√≠pio</option>`;
      const cidades = estadosECidades[ufEl.value] || [];
      cidades.forEach(cidade => {
        municipioEl.innerHTML += `<option value='${cidade}'>${cidade}</option>`;
      });
    });
  }

  ufElements.forEach(({ uf, municipio }) => preencherEstados(uf, municipio));
  // ==================== M√°scara de placas ====================
  function aplicarMascaraPlaca(input, tipo) {
    let value = input.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
    if (tipo === 'comum') {
      if (value.length > 7) value = value.slice(0, 7);
      if (value.length > 3) value = value.slice(0, 3) + '-' + value.slice(3);
    } else {
      if (value.length > 7) value = value.slice(0, 7);
    }
    input.value = value;
  }

  // ==================== M√°scara de telefone ====================
  function aplicarMascaraTelefone(input) {
    let value = input.value.replace(/\D/g, '');
    if (value.length > 11) value = value.slice(0, 11);
    if (value.length > 10) {
      value = value.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
    } else {
      value = value.replace(/(\d{2})(\d{4})(\d{0,4})/, '($1) $2-$3');
    }
    input.value = value;
  }

  // ==================== Eventos m√°scara telefone ====================
  ['achei-telefone', 'multi-achei-telefone'].forEach(id => {
    const input = document.getElementById(id);
    input.addEventListener('input', () => aplicarMascaraTelefone(input));
  });

  // ==================== Navega√ß√£o ====================
  const homeScreen = document.getElementById('home-screen');
  const perdiScreen = document.getElementById('perdi-screen');
  const acheiScreen = document.getElementById('achei-screen');
  const multiAcheiScreen = document.getElementById('multi-achei-screen');
  const avisoScreen = document.getElementById('aviso-screen');

  function switchScreen(hide, show) {
    hide.classList.remove('active');
    show.classList.add('active');
  }

  document.getElementById('perdi-btn').onclick = () => switchScreen(homeScreen, perdiScreen);
  document.getElementById('achei-btn').onclick = () => switchScreen(homeScreen, acheiScreen);
  document.getElementById('multi-achei-btn').onclick = () => {
    resetMultiPlaca();
    switchScreen(homeScreen, multiAcheiScreen);
  };
  document.getElementById('perdi-voltar').onclick = () => switchScreen(perdiScreen, homeScreen);
  document.getElementById('achei-voltar').onclick = () => switchScreen(acheiScreen, homeScreen);
  document.getElementById('multi-achei-voltar').onclick = () => switchScreen(multiAcheiScreen, homeScreen);
  document.getElementById('aviso-voltar').onclick = () => switchScreen(avisoScreen, homeScreen);

  // ==================== Controle localiza√ß√£o (UF/Munic√≠pio) ====================
  const perdeuTipoComum = document.getElementById('perdi-tipo-comum');
  const acheiTipoComum = document.getElementById('achei-tipo-comum');
  const perdeuLocalizacao = document.getElementById('perdi-localizacao');
  const acheiLocalizacao = document.getElementById('achei-localizacao');

  perdeuTipoComum.addEventListener('change', () => {
    perdeuLocalizacao.style.display = perdeuTipoComum.checked ? 'block' : 'none';
  });
  acheiTipoComum.addEventListener('change', () => {
    acheiLocalizacao.style.display = acheiTipoComum.checked ? 'block' : 'none';
  });

  perdeuLocalizacao.style.display = perdeuTipoComum.checked ? 'block' : 'none';
  acheiLocalizacao.style.display = acheiTipoComum.checked ? 'block' : 'none';

  // ==================== Multiplacas ====================
  const placasContainer = document.getElementById('placas-container');
  const addPlacaBtn = document.getElementById('add-placa-btn');
  let placasCount = 0;

  function criarPlacaCard(index) {
    return `
    <div class="placa-card" id="placa-card-${index}">
      <h4>Placa ${index + 1}</h4>
      <div class="form-group">
        <label>Tipo de placa:</label>
        <select class="multi-tipo" id="multi-tipo-${index}">
          <option value="comum">Comum (ABC-1234)</option>
          <option value="mercosul">Mercosul (ABC1D23)</option>
        </select>
      </div>
      <div class="form-group">
        <label>Placa:</label>
        <input type="text" class="multi-placa" id="multi-placa-${index}">
      </div>
      <div class="form-group multi-localizacao" id="multi-localizacao-${index}">
        <label>UF:</label>
        <select class="multi-uf" id="multi-uf-${index}"></select>
        <label>Munic√≠pio:</label>
        <select class="multi-municipio" id="multi-municipio-${index}"></select>
      </div>
      <span class="remove-placa" onclick="removerPlaca(${index})">‚ùå Remover</span>
    </div>`;
  }

  function adicionarPlaca() {
    if (placasCount >= 10) {
      alert('Limite de 10 placas atingido!');
      return;
    }
    placasContainer.innerHTML += criarPlacaCard(placasCount);
    preencherEstados(document.getElementById(`multi-uf-${placasCount}`), document.getElementById(`multi-municipio-${placasCount}`));
    const tipoSelect = document.getElementById(`multi-tipo-${placasCount}`);
    const localizacaoDiv = document.getElementById(`multi-localizacao-${placasCount}`);
    tipoSelect.addEventListener('change', () => {
      localizacaoDiv.style.display = tipoSelect.value === 'comum' ? 'block' : 'none';
    });
    localizacaoDiv.style.display = 'block'; // Padr√£o para comum
    placasCount++;
  }

  function removerPlaca(index) {
    const card = document.getElementById(`placa-card-${index}`);
    if (card) {
      card.remove();
      placasCount--;
    }
  }

  function resetMultiPlaca() {
    placasContainer.innerHTML = '';
    placasCount = 0;
    adicionarPlaca();
  }

  addPlacaBtn.onclick = () => adicionarPlaca();
  // ==================== Valida√ß√£o de placa ====================
  function validarPlaca(placa, tipo) {
    if (tipo === 'comum') {
      return /^[A-Z]{3}-\d{4}$/.test(placa);
    } else {
      return /^[A-Z]{3}\d[A-Z]\d{2}$/.test(placa);
    }
  }

  function formatarPlaca(placa) {
    return placa.replace('-', '').toUpperCase();
  }

  function validarLocalizacao(tipo, uf, municipio) {
    return tipo === 'comum' ? (uf && municipio) : true;
  }

  // ==================== Buscar placa ====================
  document.getElementById('perdi-buscar').onclick = async () => {
    const tipo = perdeuTipoComum.checked ? 'comum' : 'mercosul';
    const placa = formatarPlaca(document.getElementById('perdi-placa').value.trim());
    const uf = document.getElementById('perdi-uf').value;
    const municipio = document.getElementById('perdi-municipio').value;

    if (!validarPlaca(document.getElementById('perdi-placa').value.trim(), tipo)) {
      alert('Placa inv√°lida!');
      return;
    }
    if (!validarLocalizacao(tipo, uf, municipio)) {
      alert('UF e Munic√≠pio obrigat√≥rios para placa comum.');
      return;
    }

    const path = tipo === 'comum' ? `${uf}_${municipio}_${placa}` : placa;
    const dbRef = ref(database, 'placas/' + path);
    const snapshot = await get(dbRef);

    if (snapshot.exists()) {
      const dados = snapshot.val();
      alert(`Placa encontrada!\n\nContato: ${dados.nome} - ${dados.telefone}`);
    } else {
      if (confirm('Placa n√£o encontrada. Deseja ser avisado quando ela for cadastrada?')) {
        document.getElementById('aviso-placa').value = placa;
        switchScreen(perdiScreen, avisoScreen);
      }
    }
  };

  // ==================== Salvar placa (simples) ====================
  document.getElementById('achei-salvar').onclick = async () => {
    await salvarPlacaUnica(
      document.getElementById('achei-tipo-comum').checked ? 'comum' : 'mercosul',
      document.getElementById('achei-placa').value.trim(),
      document.getElementById('achei-nome').value.trim(),
      document.getElementById('achei-telefone').value.trim(),
      document.getElementById('achei-uf').value,
      document.getElementById('achei-municipio').value
    );
  };

  async function salvarPlacaUnica(tipo, placaInput, nome, telefone, uf, municipio) {
    const placa = formatarPlaca(placaInput);

    if (!validarPlaca(placaInput, tipo)) {
      alert('Placa inv√°lida!');
      return;
    }
    if (!nome || nome.length < 3) {
      alert('Digite seu nome.');
      return;
    }
    if (!telefone || telefone.replace(/\D/g, '').length < 10) {
      alert('Telefone inv√°lido.');
      return;
    }
    if (!validarLocalizacao(tipo, uf, municipio)) {
      alert('UF e Munic√≠pio obrigat√≥rios para placa comum.');
      return;
    }

    const path = tipo === 'comum' ? `${uf}_${municipio}_${placa}` : placa;
    const dados = {
      nome,
      telefone,
      tipo,
      uf: tipo === 'comum' ? uf : '',
      municipio: tipo === 'comum' ? municipio : '',
      timestamp: Date.now()
    };

    await set(ref(database, 'placas/' + path), dados);
    alert(`Placa ${placaInput} cadastrada com sucesso!`);
  }

  // ==================== Salvar m√∫ltiplas placas ====================
  document.getElementById('multi-achei-salvar').onclick = async () => {
    const nome = document.getElementById('multi-achei-nome').value.trim();
    const telefone = document.getElementById('multi-achei-telefone').value.trim();

    if (!nome || nome.length < 3) {
      alert('Digite seu nome.');
      return;
    }
    if (!telefone || telefone.replace(/\D/g, '').length < 10) {
      alert('Telefone inv√°lido.');
      return;
    }

    const placas = document.querySelectorAll('.placa-card');
    let sucesso = 0;
    for (let i = 0; i < placas.length; i++) {
      const tipo = document.getElementById(`multi-tipo-${i}`).value;
      const placaInput = document.getElementById(`multi-placa-${i}`).value.trim();
      const uf = document.getElementById(`multi-uf-${i}`).value;
      const municipio = document.getElementById(`multi-municipio-${i}`).value;

      try {
        await salvarPlacaUnica(tipo, placaInput, nome, telefone, uf, municipio);
        sucesso++;
      } catch (e) {
        console.error(`Erro ao salvar placa ${placaInput}:`, e);
      }
    }

    document.getElementById('multi-achei-result').className = 'result success';
    document.getElementById('multi-achei-result-text').innerText = `${sucesso} placas cadastradas com sucesso!`;
  };

  // ==================== Cadastro para ser avisado ====================
  document.getElementById('aviso-salvar').onclick = async () => {
    const nome = document.getElementById('aviso-nome').value.trim();
    const email = document.getElementById('aviso-email').value.trim();
    const placa = document.getElementById('aviso-placa').value.trim();

    if (!nome || !email) {
      document.getElementById('aviso-result').className = 'result error';
      document.getElementById('aviso-result-text').innerText = 'Preencha seu nome e e-mail.';
      return;
    }

    const userRef = doc(firestore, "users", email);
    const userSnap = await getDoc(userRef);

    if (userSnap.exists()) {
      await updateDoc(userRef, {
        placas: arrayUnion(placa),
        dataCadastro: new Date().toISOString()
      });
      document.getElementById('aviso-result').className = 'result success';
      document.getElementById('aviso-result-text').innerText = 'Cadastro atualizado! Voc√™ ser√° avisado.';
    } else {
      await setDoc(userRef, {
        nome,
        email,
        placas: [placa],
        dataCadastro: new Date().toISOString()
      });
      document.getElementById('aviso-result').className = 'result success';
      document.getElementById('aviso-result-text').innerText = 'Cadastro realizado! Voc√™ ser√° avisado.';
    }
  };
</script>
</body>
</html>
